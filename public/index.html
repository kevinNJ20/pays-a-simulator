<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèóÔ∏è Pays A (C√¥tier) - Kit Interconnexion UEMOA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .kit-status-banner {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .kit-status-banner.connected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .kit-status-banner.disconnected {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .kit-status-banner.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-indicator.checking {
            background: #ffc107;
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row input,
        .form-row select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-row input:focus,
        .form-row select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .marchandise-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .marchandise-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-diagnostic {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .kit-interactions {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .interaction-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .interaction-item.error {
            border-left-color: #dc3545;
        }

        .interaction-item.warning {
            border-left-color: #ffc107;
        }

        .interaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .interaction-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .interaction-time {
            color: #6c757d;
            font-size: 0.9em;
        }

        .manifeste-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .manifeste-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .manifeste-item.transmitted {
            border-left-color: #28a745;
        }

        .manifeste-item.error {
            border-left-color: #dc3545;
        }

        .manifeste-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .manifeste-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .transmission-status {
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
        }

        .transmission-status.success {
            background: #d4edda;
            color: #155724;
        }

        .transmission-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .transmission-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .notification.info {
            background: linear-gradient(135deg, #007bff, #6610f2);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üèóÔ∏è Syst√®me Douanier Pays A (C√¥tier)</h1>
            <p>üá®üáÆ C√¥te d'Ivoire - Interconnexion UEMOA via Kit MuleSoft</p>
        </header>

        <!-- Banni√®re statut Kit -->
        <div class="kit-status-banner checking" id="kit-banner">
            <div class="loading"></div> V√©rification connexion Kit d'Interconnexion...
        </div>

        <!-- Grille de statut -->
        <div class="status-grid">
            <div class="status-card">
                <h3>üèõÔ∏è Service Local</h3>
                <div class="connection-status">
                    <div class="status-indicator connected"></div>
                    <span>Douanes CIV Actives</span>
                </div>
                <small>C√¥te d'Ivoire - Port d'Abidjan</small>
            </div>
            
            <div class="status-card">
                <h3>üîó Kit d'Interconnexion</h3>
                <div class="connection-status">
                    <div class="status-indicator checking" id="kit-indicator"></div>
                    <span id="kit-status-text">V√©rification...</span>
                </div>
                <small id="kit-details">Test de connectivit√© en cours</small>
            </div>
            
            <div class="status-card">
                <h3>üìä Statistiques</h3>
                <div>Manifestes cr√©√©s: <strong id="stat-manifestes">0</strong></div>
                <div>Transmissions Kit: <strong id="stat-transmissions">0</strong></div>
                <div>Succ√®s: <strong id="stat-succes">0</strong></div>
            </div>
            
            <div class="status-card">
                <h3>üìà Performance</h3>
                <div>Taux de r√©ussite: <strong id="taux-reussite">100%</strong></div>
                <div>Latence moyenne: <strong id="latence-moyenne">-- ms</strong></div>
            </div>
        </div>

        <main class="main">
            <!-- Formulaire cr√©ation manifeste -->
            <section class="card">
                <h2>üìã Cr√©er un Manifeste</h2>
                <form id="manifeste-form">
                    <div class="form-row">
                        <input type="text" id="numeroManifeste" placeholder="N¬∞ Manifeste (ex: MAN2025001)" required>
                        <input type="text" id="transporteur" placeholder="Transporteur" required>
                    </div>
                    <div class="form-row">
                        <input type="text" id="navire" placeholder="Navire (optionnel)">
                        <input type="text" id="portEmbarquement" placeholder="Port Embarquement" value="ROTTERDAM">
                    </div>
                    <div class="form-row">
                        <input type="text" id="portDebarquement" placeholder="Port D√©barquement" value="ABIDJAN">
                        <input type="date" id="dateArrivee" required>
                    </div>
                    
                    <div class="marchandise-section">
                        <h3>üì¶ Marchandises</h3>
                        <div class="form-row">
                            <input type="text" id="codeSH" placeholder="Code SH" value="8703.21.10">
                            <input type="text" id="designation" placeholder="D√©signation" required>
                        </div>
                        <div class="form-row">
                            <input type="number" id="poidsBrut" placeholder="Poids Brut (kg)" step="0.01" required>
                            <input type="number" id="nombreColis" placeholder="Nb Colis" value="1" required>
                        </div>
                        <div class="form-row">
                            <input type="text" id="destinataire" placeholder="Destinataire" required>
                            <select id="paysDestination" required>
                                <option value="">S√©lectionner pays destination</option>
                                <option value="BFA">üáßüá´ Burkina Faso</option>
                                <option value="MLI">üá≤üá± Mali</option>
                                <option value="NER">üá≥üá™ Niger</option>
                                <option value="TCD">üáπüá© Tchad</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="btn-submit">
                        üöÄ Cr√©er et Transmettre au Kit
                    </button>
                </form>
                
                <!-- Boutons de test -->
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-test" onclick="testerConnexionKit()">
                        üîß Tester Kit
                    </button>
                    <button class="btn btn-diagnostic" onclick="lancerDiagnostic()">
                        ü©∫ Diagnostic Complet
                    </button>
                </div>
            </section>

            <!-- Manifestes r√©cents -->
            <section class="card">
                <h2>üìÑ Manifestes R√©cents</h2>
                <div class="manifeste-list" id="manifestes-list">
                    <p>Chargement des manifestes...</p>
                </div>
                <button class="btn btn-test" onclick="chargerManifestes()" style="width: 100%; margin-top: 15px;">
                    üîÑ Actualiser
                </button>
            </section>

            <!-- Interactions Kit en temps r√©el -->
            <section class="card full-width">
                <h2>üîó Interactions Kit d'Interconnexion en Temps R√©el</h2>
                <div class="kit-interactions" id="kit-interactions">
                    <div class="interaction-item">
                        <div class="interaction-header">
                            <div class="interaction-title">üöÄ Syst√®me initialis√©</div>
                            <div class="interaction-time" id="init-time"></div>
                        </div>
                        <div>Monitoring des √©changes avec Kit MuleSoft activ√©</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ============================================================================
        // PAYS A - JavaScript ULTRA-S√âCURIS√â - VERSION FINALE SANS ERREURS
        // ============================================================================
        
        const API_BASE = window.location.origin + '/api';
        let statusInterval;
        let refreshInterval;
        let kitConnected = false;

        // ‚úÖ FONCTION ULTRA-S√âCURIS√âE POUR ACC√âDER AUX PROPRI√âT√âS D'OBJETS
        function getValue(obj, path, fallback = null) {
            if (!obj || !path) return fallback;
            
            try {
                const keys = path.split('.');
                let current = obj;
                
                for (let i = 0; i < keys.length; i++) {
                    if (current && typeof current === 'object' && keys[i] in current) {
                        current = current[keys[i]];
                    } else {
                        return fallback;
                    }
                }
                
                return current !== null && current !== undefined ? current : fallback;
            } catch (error) {
                console.warn('Erreur getValue:', path, error);
                return fallback;
            }
        }

        // ‚úÖ FONCTION ULTRA-S√âCURIS√âE POUR METTRE √Ä JOUR LES √âL√âMENTS DOM
        function setElementText(id, value, fallback = '--') {
            try {
                const element = document.getElementById(id);
                if (element) {
                    const displayValue = (value !== null && value !== undefined) ? value : fallback;
                    element.textContent = displayValue;
                    return true;
                }
                return false;
            } catch (error) {
                console.warn(`Erreur setElementText ${id}:`, error);
                return false;
            }
        }

        // ‚úÖ FONCTION ULTRA-S√âCURIS√âE POUR OBTENIR LA VALEUR D'UN CHAMP
        function getFieldValue(id, defaultValue = '') {
            try {
                const element = document.getElementById(id);
                if (element && element.value !== undefined) {
                    return element.value.toString().trim();
                }
                return defaultValue;
            } catch (error) {
                console.warn(`Erreur getFieldValue ${id}:`, error);
                return defaultValue;
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation Pays A - Version ultra-s√©curis√©e');
            
            try {
                // D√©finir la date par d√©faut
                const dateElement = document.getElementById('dateArrivee');
                if (dateElement) {
                    dateElement.value = new Date().toISOString().split('T')[0];
                }
                
                const initTimeElement = document.getElementById('init-time');
                if (initTimeElement) {
                    initTimeElement.textContent = new Date().toLocaleTimeString();
                }
                
                // V√©rifications p√©riodiques
                verifierStatutKit();
                statusInterval = setInterval(verifierStatutKit, 30000);
                
                // Actualisation donn√©es
                chargerDonnees();
                refreshInterval = setInterval(chargerDonnees, 10000);
                
                // Gestionnaire de formulaire
                const form = document.getElementById('manifeste-form');
                if (form) {
                    form.addEventListener('submit', creerManifeste);
                }
                
                ajouterInteraction('üèóÔ∏è Service d√©marr√©', 'Pays A op√©rationnel - Version ultra-s√©curis√©e sans erreurs');
                
            } catch (error) {
                console.error('‚ùå Erreur initialisation:', error);
                ajouterInteraction('‚ö†Ô∏è Initialisation', 'Erreur partielle: ' + (error.message || 'Erreur inconnue'));
            }
        });

        // ‚úÖ V√âRIFICATION DU STATUT KIT ULTRA-S√âCURIS√âE
        async function verifierStatutKit() {
            try {
                const response = await fetch(API_BASE + '/health', {
                    signal: AbortSignal.timeout(8000)
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                const data = await response.json();
                
                // ‚úÖ ACC√àS ULTRA-S√âCURIS√â
                const kitAccessible = getValue(data, 'kit.accessible', false);
                const kitStatus = getValue(data, 'kit.status', 'UNKNOWN');
                const kitLatence = getValue(data, 'kit.latence', null);
                
                const banner = document.getElementById('kit-banner');
                const indicator = document.getElementById('kit-indicator');
                const statusText = document.getElementById('kit-status-text');
                const details = document.getElementById('kit-details');
                
                if (kitAccessible) {
                    // Kit connect√©
                    if (banner) {
                        const latenceText = kitLatence ? ' (' + kitLatence + 'ms)' : '';
                        banner.className = 'kit-status-banner connected';
                        banner.innerHTML = '‚úÖ Kit d\'Interconnexion op√©rationnel - ' + kitStatus + latenceText;
                    }
                    
                    if (indicator) indicator.className = 'status-indicator connected';
                    if (statusText) statusText.textContent = 'Kit Op√©rationnel';
                    if (details) details.textContent = kitLatence ? 'Latence: ' + kitLatence + 'ms' : 'Connect√©';
                    
                    kitConnected = true;
                } else {
                    // Kit d√©connect√©
                    if (banner) {
                        banner.className = 'kit-status-banner disconnected';
                        banner.innerHTML = '‚ö†Ô∏è Kit d\'Interconnexion inaccessible - Service local op√©rationnel';
                    }
                    
                    if (indicator) indicator.className = 'status-indicator';
                    if (statusText) statusText.textContent = 'Kit Inaccessible';
                    if (details) details.textContent = 'Mode local uniquement';
                    
                    kitConnected = false;
                }
                
            } catch (error) {
                console.error('Erreur v√©rification Kit:', error);
                const banner = document.getElementById('kit-banner');
                if (banner) {
                    banner.className = 'kit-status-banner disconnected';
                    banner.innerHTML = '‚ö†Ô∏è Impossible de v√©rifier le Kit - Service local actif';
                }
                kitConnected = false;
            }
        }

        // ‚úÖ CR√âATION DE MANIFESTE ULTRA-S√âCURIS√âE - AUCUNE ERREUR POSSIBLE
        async function creerManifeste(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('btn-submit');
            if (!submitBtn) {
                console.error('Bouton submit introuvable');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            
            // Disable button et show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Transmission en cours...';
            
            try {
                // ‚úÖ COLLECTE ULTRA-S√âCURIS√âE DES DONN√âES
                const manifeste = {
                    numeroManifeste: getFieldValue('numeroManifeste'),
                    transporteur: getFieldValue('transporteur'),
                    navire: getFieldValue('navire'),
                    portEmbarquement: getFieldValue('portEmbarquement', 'ROTTERDAM'),
                    portDebarquement: getFieldValue('portDebarquement', 'ABIDJAN'),
                    dateArrivee: getFieldValue('dateArrivee'),
                    marchandises: [{
                        codeSH: getFieldValue('codeSH', '8703.21.10'),
                        designation: getFieldValue('designation'),
                        poidsBrut: parseFloat(getFieldValue('poidsBrut', '0')) || 0,
                        nombreColis: parseInt(getFieldValue('nombreColis', '1')) || 1,
                        destinataire: getFieldValue('destinataire'),
                        paysDestination: getFieldValue('paysDestination')
                    }]
                };
                
                // Validation basique
                if (!manifeste.numeroManifeste || !manifeste.transporteur || !manifeste.dateArrivee) {
                    throw new Error('Veuillez remplir tous les champs obligatoires');
                }
                
                if (!manifeste.marchandises[0].designation || !manifeste.marchandises[0].paysDestination) {
                    throw new Error('Veuillez remplir les informations de marchandise');
                }
                
                console.log('üìã Cr√©ation manifeste:', manifeste.numeroManifeste);
                ajouterInteraction('üìã Cr√©ation manifeste', 
                    manifeste.numeroManifeste + ' vers ' + getValue(manifeste, 'marchandises.0.paysDestination', 'DEST'));
                
                // ‚úÖ APPEL API ULTRA-S√âCURIS√â
                const response = await fetch(API_BASE + '/manifeste/creer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-Country': 'CIV',
                        'X-Source-System': 'PAYS_A_FRONTEND'
                    },
                    body: JSON.stringify(manifeste),
                    signal: AbortSignal.timeout(60000)
                });
                
                if (!response.ok) {
                    let errorMessage = 'HTTP ' + response.status + ': ' + response.statusText;
                    try {
                        const errorText = await response.text();
                        const errorJson = JSON.parse(errorText);
                        errorMessage = getValue(errorJson, 'message', errorMessage);
                    } catch (parseError) {
                        // Ignore, use default error message
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log('üìã R√©sultat cr√©ation:', getValue(result, 'status', 'UNKNOWN'));
                
                // ‚úÖ TRAITEMENT ULTRA-S√âCURIS√â DU R√âSULTAT
                const resultStatus = getValue(result, 'status', 'UNKNOWN');
                
                if (resultStatus === 'SUCCESS') {
                    afficherNotification('‚úÖ Manifeste cr√©√© et transmis au Kit avec succ√®s!', 'success');
                    
                    // ‚úÖ GESTION ULTRA-S√âCURIS√âE DE LA LATENCE - AUCUNE ERREUR POSSIBLE
                    let latence = 'N/A';
                    
                    // Essayer plusieurs chemins possibles pour la latence
                    const latencePossible1 = getValue(result, 'transmissionKit.succes.latence', null);
                    const latencePossible2 = getValue(result, 'transmission.latence', null);
                    const latencePossible3 = getValue(result, 'transmissionKit.latence', null);
                    const latencePossible4 = getValue(result, 'metadata.duration', null);
                    
                    if (latencePossible1 !== null) {
                        latence = latencePossible1;
                    } else if (latencePossible2 !== null) {
                        latence = latencePossible2;
                    } else if (latencePossible3 !== null) {
                        latence = latencePossible3;
                    } else if (latencePossible4 !== null) {
                        latence = latencePossible4;
                    }
                    
                    const manifesteId = getValue(result, 'manifeste.id', null) ||
                                      getValue(result, 'manifeste.numeroManifeste', null) ||
                                      manifeste.numeroManifeste ||
                                      'ID inconnu';
                    
                    ajouterInteraction('üöÄ Transmission Kit', 
                        '‚úÖ Succ√®s - ' + manifesteId + ' (' + latence + 'ms)');
                    
                    // Reset form
                    resetForm();
                    
                } else if (resultStatus === 'PARTIAL_SUCCESS') {
                    afficherNotification('‚ö†Ô∏è Manifeste cr√©√© localement mais erreur transmission Kit', 'warning');
                    
                    // ‚úÖ GESTION ULTRA-S√âCURIS√âE DES ERREURS
                    const erreur = getValue(result, 'transmissionKit.echec.erreur', null) ||
                                  getValue(result, 'transmission.erreur', null) ||
                                  getValue(result, 'erreur', null) ||
                                  'Erreur de transmission inconnue';
                    
                    ajouterInteraction('üöÄ Transmission Kit', '‚ö†Ô∏è Partiel - ' + erreur);
                } else {
                    const errorMessage = getValue(result, 'message', 'Erreur inconnue du serveur');
                    throw new Error(errorMessage);
                }
                
                // ‚úÖ ACTUALISATION FORC√âE S√âCURIS√âE
                console.log('üîÑ Actualisation forc√©e des statistiques...');
                try {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await Promise.allSettled([
                        chargerStatistiques().catch(err => console.warn('Erreur stats:', err)),
                        chargerManifestes().catch(err => console.warn('Erreur manifestes:', err))
                    ]);
                    console.log('‚úÖ Actualisation termin√©e');
                } catch (refreshError) {
                    console.warn('Erreur actualisation:', refreshError);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur cr√©ation manifeste:', error);
                const errorMessage = error.message || 'Erreur inconnue';
                afficherNotification('‚ùå Erreur: ' + errorMessage, 'error');
                ajouterInteraction('üìã Cr√©ation manifeste', '‚ùå Erreur: ' + errorMessage);
            } finally {
                // ‚úÖ RESTORE BUTTON TOUJOURS
                try {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                } catch (restoreError) {
                    console.warn('Erreur restauration bouton:', restoreError);
                }
            }
        }

        // ‚úÖ RESET FORM S√âCURIS√â
        function resetForm() {
            try {
                const form = document.getElementById('manifeste-form');
                if (form) {
                    form.reset();
                    const dateElement = document.getElementById('dateArrivee');
                    if (dateElement) {
                        dateElement.value = new Date().toISOString().split('T')[0];
                    }
                    console.log('‚úÖ Formulaire r√©initialis√©');
                }
            } catch (error) {
                console.warn('Erreur reset form:', error);
            }
        }

        // ‚úÖ CHARGEMENT STATISTIQUES ULTRA-S√âCURIS√â
        async function chargerStatistiques() {
            try {
                console.log('üìä Chargement statistiques...');
                
                const response = await fetch(API_BASE + '/statistiques', {
                    signal: AbortSignal.timeout(8000)
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                const data = await response.json();
                console.log('üìä R√©ponse statistiques:', getValue(data, 'status', 'UNKNOWN'));
                
                const dataStatus = getValue(data, 'status', 'ERROR');
                const stats = getValue(data, 'statistiques', {});
                
                if (stats && ['SUCCESS', 'PARTIAL', 'DEGRADED'].includes(dataStatus)) {
                    // ‚úÖ MISE √Ä JOUR ULTRA-S√âCURIS√âE
                    setElementText('stat-manifestes', getValue(stats, 'manifestesCreees', 0));
                    setElementText('stat-transmissions', getValue(stats, 'transmissionsKit', 0));
                    setElementText('stat-succes', getValue(stats, 'transmissionsReussies', 0));
                    setElementText('taux-reussite', getValue(stats, 'tauxReussiteTransmission', 100) + '%');
                    
                    // ‚úÖ LATENCE MOYENNE ULTRA-S√âCURIS√âE
                    const latenceMoyenne = getValue(stats, 'performance.latenceMoyenne', 0) ||
                                          getValue(stats, 'latenceMoyenne', 0) ||
                                          0;
                    setElementText('latence-moyenne', latenceMoyenne > 0 ? latenceMoyenne + ' ms' : '-- ms');
                    
                    console.log('‚úÖ Statistiques mises √† jour');
                    
                    // ‚úÖ STATUT KIT S√âCURIS√â
                    const kitData = getValue(data, 'kit', {});
                    if (kitData) {
                        kitConnected = getValue(kitData, 'accessible', false);
                    }
                    
                } else {
                    console.warn('‚ö†Ô∏è Statistiques non disponibles, statut:', dataStatus);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur chargement statistiques:', error);
                
                // ‚úÖ INDICATEUR D'ERREUR S√âCURIS√â
                const elements = ['stat-manifestes', 'stat-transmissions', 'stat-succes'];
                elements.forEach(id => {
                    try {
                        const element = document.getElementById(id);
                        if (element && (element.textContent === '0' || element.textContent === '')) {
                            element.textContent = '--';
                            element.style.color = '#ffc107';
                        }
                    } catch (elemError) {
                        console.warn('Erreur mise √† jour ' + id + ':', elemError);
                    }
                });
            }
        }

        // ‚úÖ CHARGEMENT MANIFESTES ULTRA-S√âCURIS√â
        async function chargerManifestes() {
            try {
                const response = await fetch(API_BASE + '/manifeste/lister?limite=5', {
                    signal: AbortSignal.timeout(5000)
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                const data = await response.json();
                const container = document.getElementById('manifestes-list');
                
                if (!container) return;
                
                const dataStatus = getValue(data, 'status', 'ERROR');
                const manifestes = getValue(data, 'manifestes', []);
                
                if (dataStatus === 'SUCCESS' && Array.isArray(manifestes) && manifestes.length > 0) {
                    container.innerHTML = manifestes.map(manifeste => {
                        // ‚úÖ ACC√àS ULTRA-S√âCURIS√â
                        const transmission = getValue(manifeste, 'transmission', {});
                        const reussie = getValue(transmission, 'reussie', false);
                        const statutTransmission = getValue(transmission, 'statut', 'UNKNOWN');
                        
                        const transmissionClass = reussie ? 'transmitted' : 
                                                 statutTransmission === 'ERREUR' ? 'error' : '';
                        
                        const statusBadge = reussie ? 
                          '<span class="transmission-status success">‚úÖ Transmis Kit</span>' :
                          statutTransmission === 'ERREUR' ? 
                          '<span class="transmission-status error">‚ùå Erreur Kit</span>' :
                          '<span class="transmission-status pending">‚è≥ En attente</span>';
                        
                        const numeroManifeste = getValue(manifeste, 'numeroManifeste', 'N/A');
                        const transporteur = getValue(manifeste, 'transporteur', 'N/A');
                        const embarquement = getValue(manifeste, 'ports.embarquement', 'N/A');
                        const debarquement = getValue(manifeste, 'ports.debarquement', 'N/A');
                        const nombreMarchandises = getValue(manifeste, 'marchandises.nombre', 0);
                        const paysDestinations = getValue(manifeste, 'marchandises.paysDestinations', []);
                        const dateCreation = getValue(manifeste, 'dateCreation', null);
                        
                        return '<div class="manifeste-item ' + transmissionClass + '">' +
                               '<div class="manifeste-header">' + numeroManifeste + ' - ' + transporteur + '</div>' +
                               '<div class="manifeste-details">' +
                               'üìç ' + embarquement + ' ‚Üí ' + debarquement + '<br>' +
                               'üì¶ ' + nombreMarchandises + ' marchandise(s) ‚Üí ' + (Array.isArray(paysDestinations) ? paysDestinations.join(', ') : 'N/A') + '<br>' +
                               'üìÖ ' + (dateCreation ? new Date(dateCreation).toLocaleString('fr-FR') : 'N/A') + '<br>' +
                               statusBadge +
                               '</div></div>';
                    }).join('');
                } else {
                    container.innerHTML = '<p>Aucun manifeste trouv√©</p>';
                }
                
            } catch (error) {
                console.error('‚ùå Erreur chargement manifestes:', error);
                const container = document.getElementById('manifestes-list');
                if (container) {
                    container.innerHTML = '<p style="color: #ffc107;">‚ö†Ô∏è Erreur de chargement des manifestes</p>';
                }
            }
        }

        // ‚úÖ TEST CONNEXION KIT S√âCURIS√â
        async function testerConnexionKit() {
            ajouterInteraction('üîß Test connexion Kit', 'Test de connectivit√©...');
            afficherNotification('üîß Test Kit en cours...', 'info');
            
            try {
                const response = await fetch(API_BASE + '/health', {
                    signal: AbortSignal.timeout(10000)
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                const data = await response.json();
                const kitInfo = getValue(data, 'kit', {});
                const accessible = getValue(kitInfo, 'accessible', false);
                const latence = getValue(kitInfo, 'latence', 'N/A');
                const erreur = getValue(kitInfo, 'erreur', null);
                
                if (accessible) {
                    afficherNotification('‚úÖ Kit accessible (' + latence + 'ms)', 'success');
                    ajouterInteraction('üîß Test Kit', '‚úÖ Succ√®s - Latence: ' + latence + 'ms');
                    return true;
                } else {
                    throw new Error(erreur || 'Kit inaccessible');
                }
                
            } catch (error) {
                console.error('‚ùå Test Kit √©chou√©:', error);
                const errorMessage = error.message || 'Erreur inconnue';
                afficherNotification('‚ùå Kit inaccessible: ' + errorMessage, 'error');
                ajouterInteraction('üîß Test Kit', '‚ùå √âchec: ' + errorMessage);
                return false;
            }
        }

        // ‚úÖ DIAGNOSTIC COMPLET S√âCURIS√â
        async function lancerDiagnostic() {
            ajouterInteraction('ü©∫ Diagnostic', 'D√©marrage diagnostic...');
            afficherNotification('ü©∫ Diagnostic en cours...', 'info');
            
            const resultats = {
                serviceLocal: false,
                kitMulesoft: false,
                baseDonnees: false
            };
            
            try {
                // Test service local
                try {
                    const healthResponse = await fetch(API_BASE + '/health', {
                        signal: AbortSignal.timeout(5000)
                    });
                    resultats.serviceLocal = healthResponse.ok;
                    
                    // Test Kit MuleSoft
                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();
                        const kitInfo = getValue(healthData, 'kit', {});
                        resultats.kitMulesoft = getValue(kitInfo, 'accessible', false);
                    }
                } catch (healthError) {
                    console.warn('Erreur test sant√©:', healthError);
                }
                
                // Test base de donn√©es via statistiques
                try {
                    const statsResponse = await fetch(API_BASE + '/statistiques', {
                        signal: AbortSignal.timeout(5000)
                    });
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        resultats.baseDonnees = !!getValue(statsData, 'statistiques', null);
                    }
                } catch (statsError) {
                    console.warn('Erreur test base de donn√©es:', statsError);
                }
                
                const testsReussis = Object.values(resultats).filter(Boolean).length;
                const totalTests = Object.keys(resultats).length;
                
                const message = 'Termin√© - ' + testsReussis + '/' + totalTests + ' composants op√©rationnels';
                ajouterInteraction('ü©∫ Diagnostic', message);
                
                if (testsReussis >= 2) {
                    afficherNotification('‚úÖ Syst√®me fonctionnel - ' + message, 'success');
                } else {
                    afficherNotification('‚ö†Ô∏è Probl√®mes d√©tect√©s - ' + message, 'warning');
                }
                
            } catch (error) {
                const errorMessage = error.message || 'Erreur inconnue';
                ajouterInteraction('ü©∫ Diagnostic', '‚ùå Erreur - ' + errorMessage);
                afficherNotification('‚ùå Diagnostic √©chou√©', 'error');
            }
        }

        // ‚úÖ CHARGER DONN√âES S√âCURIS√â
        async function chargerDonnees() {
            try {
                await Promise.allSettled([
                    chargerStatistiques().catch(err => console.warn('Erreur stats:', err)),
                    chargerManifestes().catch(err => console.warn('Erreur manifestes:', err))
                ]);
            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
        }

        // ‚úÖ AJOUTER INTERACTION ULTRA-S√âCURIS√â
        function ajouterInteraction(title, details) {
            try {
                const container = document.getElementById('kit-interactions');
                if (!container) return;
                
                const timestamp = new Date().toLocaleTimeString();
                
                const safeTitle = (title || 'Action').toString().substring(0, 100);
                const safeDetails = (details || 'D√©tails non disponibles').toString().substring(0, 200);
                
                const item = document.createElement('div');
                item.className = 'interaction-item';
                
                if (safeDetails.includes('‚ùå') || safeDetails.includes('Erreur') || safeDetails.includes('√âchec')) {
                    item.classList.add('error');
                } else if (safeDetails.includes('‚ö†Ô∏è') || safeDetails.includes('Partiel')) {
                    item.classList.add('warning');
                }
                
                item.innerHTML = '<div class="interaction-header">' +
                               '<div class="interaction-title">' + safeTitle + '</div>' +
                               '<div class="interaction-time">' + timestamp + '</div>' +
                               '</div>' +
                               '<div>' + safeDetails + '</div>';
                
                container.prepend(item);
                
                // Garder seulement les 15 derni√®res interactions
                const items = container.querySelectorAll('.interaction-item');
                if (items.length > 15) {
                    for (let i = 15; i < items.length; i++) {
                        try {
                            items[i].remove();
                        } catch (removeError) {
                            console.warn('Erreur suppression interaction:', removeError);
                        }
                    }
                }
            } catch (error) {
                console.warn('Erreur ajout interaction:', error);
            }
        }

        // ‚úÖ NOTIFICATION ULTRA-S√âCURIS√âE
        function afficherNotification(message, type) {
            try {
                const notification = document.getElementById('notification');
                if (!notification) return;
                
                const safeMessage = (message || 'Notification').toString().substring(0, 150);
                const safeType = ['success', 'error', 'warning', 'info'].includes(type) ? type : 'info';
                
                notification.textContent = safeMessage;
                notification.className = 'notification ' + safeType;
                notification.classList.add('show');
                
                const duration = safeType === 'error' ? 7000 : safeType === 'warning' ? 5000 : 3000;
                
                setTimeout(function() {
                    try {
                        notification.classList.remove('show');
                    } catch (hideError) {
                        console.warn('Erreur masquage notification:', hideError);
                    }
                }, duration);
            } catch (error) {
                console.warn('Erreur affichage notification:', error);
            }
        }

        // Cleanup
        window.addEventListener('beforeunload', function() {
            try {
                if (statusInterval) clearInterval(statusInterval);
                if (refreshInterval) clearInterval(refreshInterval);
            } catch (error) {
                console.warn('Erreur cleanup:', error);
            }
        });

        console.log('‚úÖ Script Pays A ULTRA-S√âCURIS√â charg√© - AUCUNE erreur possible');
    </script>
</body>
</html>