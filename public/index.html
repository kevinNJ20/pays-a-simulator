<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üá∏üá≥ S√©n√©gal - Port de Dakar - Syst√®me Douanier UEMOA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #00a651 0%, #ff0000 50%, #ffcc00 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header-logo {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 80px;
        }

        .senegal-flag {
            width: 80px;
            height: 60px;
            display: flex;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .flag-stripe {
            flex: 1;
            position: relative;
        }

        .flag-green {
            background: #00a651;
        }

        .flag-yellow {
            background: #ffcc00;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flag-red {
            background: #ff0000;
        }

        .flag-star {
            color: #00a651;
            font-size: 24px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .kit-status-banner {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .kit-status-banner.connected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .kit-status-banner.disconnected {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .kit-status-banner.checking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-indicator.checking {
            background: #ffc107;
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #00a651;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            outline: none;
            border-color: #00a651;
            box-shadow: 0 0 0 3px rgba(0, 166, 81, 0.1);
        }

        .article-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .article-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .conteneur-section {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #17a2b8;
        }

        .conteneur-section h5 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00a651 0%, #ff0000 100%);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 166, 81, 0.3);
        }

        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-diagnostic {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .btn-add {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
            font-size: 12px;
            padding: 8px 16px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .kit-interactions {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #00a651;
        }

        .interaction-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .interaction-item.error {
            border-left-color: #dc3545;
        }

        .interaction-item.warning {
            border-left-color: #ffc107;
        }

        .interaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .interaction-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .interaction-time {
            color: #6c757d;
            font-size: 0.9em;
        }

        .manifeste-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .manifeste-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #00a651;
        }

        .manifeste-item.transmitted {
            border-left-color: #28a745;
        }

        .manifeste-item.error {
            border-left-color: #dc3545;
        }

        .manifeste-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .manifeste-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .transmission-status {
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
        }

        .transmission-status.success {
            background: #d4edda;
            color: #155724;
        }

        .transmission-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .transmission-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .notification.info {
            background: linear-gradient(135deg, #007bff, #6610f2);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #apurement-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
        }

        #apurement-section h2 {
            color: #1976d2;
        }

        #apurement-section .form-section {
            background: white;
        }

        #apurement-section .manifeste-item {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }

        @media (max-width: 768px) {
            .main {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .header-logo {
                position: static;
                transform: none;
                margin: 0 auto 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="header-logo">
                <div class="senegal-flag">
                    <div class="flag-stripe flag-green"></div>
                    <div class="flag-stripe flag-yellow">
                        <div class="flag-star">‚òÖ</div>
                    </div>
                    <div class="flag-stripe flag-red"></div>
                </div>
            </div>
            <h1>üá∏üá≥ Syst√®me Douanier S√©n√©gal</h1>
            <p>Port de Dakar - Pays de Prime Abord - Interconnexion UEMOA</p>
        </header>

        <div class="kit-status-banner checking" id="kit-banner">
            <div class="loading"></div> V√©rification connexion Kit d'Interconnexion...
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>üèõÔ∏è Douanes S√©n√©gal</h3>
                <div class="connection-status">
                    <div class="status-indicator connected"></div>
                    <span>Port de Dakar Actif</span>
                </div>
                <small>S√©n√©gal - Pays de prime abord</small>
            </div>

            <div class="status-card">
                <h3>üîó Kit d'Interconnexion</h3>
                <div class="connection-status">
                    <div class="status-indicator checking" id="kit-indicator"></div>
                    <span id="kit-status-text">V√©rification...</span>
                </div>
                <small id="kit-details">Test de connectivit√© en cours</small>
            </div>

            <div class="status-card">
                <h3>üìä Statistiques</h3>
                <div>Manifestes cr√©√©s: <strong id="stat-manifestes">0</strong></div>
                <div>Transmissions Kit: <strong id="stat-transmissions">0</strong></div>
                <div>Succ√®s: <strong id="stat-succes">0</strong></div>
            </div>

            <div class="status-card">
                <h3>üìà Performance</h3>
                <div>Taux de r√©ussite: <strong id="taux-reussite">100%</strong></div>
                <div>Latence moyenne: <strong id="latence-moyenne">-- ms</strong></div>
            </div>
        </div>

        <main class="main">
            <section class="card">
                <h2>üìã Cr√©er un Manifeste (Format UEMOA - Port de Dakar)</h2>
                <form id="manifeste-form">
                    <div class="form-section">
                        <h3>üìÑ Informations Manifeste</h3>
                        <div class="form-row">
                            <input type="text" id="annee_manif" placeholder="Ann√©e manifeste" value="2025" required>
                            <input type="text" id="bureau_manif" placeholder="Bureau manifeste" value="18N" required>
                        </div>
                        <div class="form-row">
                            <input type="number" id="numero_manif" placeholder="Num√©ro manifeste" required>
                            <input type="text" id="code_cgt" placeholder="Code CGT" value="014" required>
                        </div>
                        <div class="form-row">
                            <input type="text" id="consignataire" placeholder="Consignataire" required>
                            <input type="text" id="repertoire" placeholder="R√©pertoire" value="02402">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üö¢ Informations Navire</h3>
                        <div class="form-row">
                            <input type="text" id="navire" placeholder="Nom du navire" required>
                            <input type="text" id="provenance" placeholder="Provenance" required>
                        </div>
                        <div class="form-row">
                            <input type="text" id="pavillon" placeholder="Pavillon" required>
                            <input type="date" id="date_arrivee" required>
                        </div>
                        <div class="form-row single">
                            <input type="number" id="valapprox" placeholder="Valeur approximative" value="0"
                                step="0.01">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üì¶ Articles</h3>
                        <div id="articles-container">
                            <div class="article-section" data-article="0">
                                <h4>Article 1</h4>
                                <div class="form-row triple">
                                    <input type="number" name="art" placeholder="N¬∞ Article" value="1" required>
                                    <input type="number" name="prec1" placeholder="Pr√©cision 1" value="0">
                                    <input type="number" name="prec2" placeholder="Pr√©cision 2" value="0">
                                </div>
                                <div class="form-row">
                                    <input type="date" name="date_emb" placeholder="Date embarquement" required>
                                    <input type="text" name="lieu_emb" placeholder="Lieu embarquement" required>
                                </div>
                                <div class="form-row">
                                    <select name="pays_dest" required>
                                        <option value="">Pays destination</option>
                                        <option value="MALI">üá≤üá± MALI</option>
                                        <option value="BURKINA FASO">üáßüá´ BURKINA FASO</option>
                                        <option value="NIGER">üá≥üá™ NIGER</option>
                                        <option value="C√îTE D'IVOIRE">üá®üáÆ C√îTE D'IVOIRE</option>
                                        <option value="GUINEA-BISSAU">üá¨üáº GUINEA-BISSAU</option>
                                        <option value="TOGO">üáπüá¨ TOGO</option>
                                        <option value="B√âNIN">üáßüáØ B√âNIN</option>
                                    </select>
                                    <input type="text" name="ville_dest" placeholder="Ville destination" required>
                                </div>
                                <div class="form-row">
                                    <input type="text" name="connaissement" placeholder="Connaissement" required>
                                    <input type="text" name="expediteur" placeholder="Exp√©diteur" required>
                                </div>
                                <div class="form-row">
                                    <input type="text" name="destinataire" placeholder="Destinataire" required>
                                    <input type="text" name="voie_dest" placeholder="Voie destination">
                                </div>
                                <div class="form-row">
                                    <input type="text" name="ordre" placeholder="√Ä l'ordre de">
                                    <input type="text" name="marchandise" placeholder="Description marchandise"
                                        required>
                                </div>
                                <div class="form-row triple">
                                    <input type="number" name="poids" placeholder="Poids (kg)" step="0.01" required>
                                    <input type="number" name="nbre_colis" placeholder="Nombre colis" required>
                                    <input type="text" name="marque" placeholder="Marque" value="NM">
                                </div>
                                <div class="form-row">
                                    <input type="text" name="mode_cond" placeholder="Mode conditionnement"
                                        value="COLIS (PACKAGE)">
                                    <input type="number" name="nbre_conteneur" placeholder="Nombre conteneurs" value="1"
                                        min="0">
                                </div>

                                <div class="conteneurs-container">
                                    <div class="conteneur-section" data-conteneur="0">
                                        <h5>Conteneur 1</h5>
                                        <div class="form-row">
                                            <input type="text" name="conteneur" placeholder="N¬∞ Conteneur" required>
                                            <select name="type" required>
                                                <option value="">Type conteneur</option>
                                                <option value="DRS">DRS - Dry Standard</option>
                                                <option value="REF">REF - Refrigerated</option>
                                                <option value="OPT">OPT - Open Top</option>
                                                <option value="FLT">FLT - Flat Rack</option>
                                            </select>
                                        </div>
                                        <div class="form-row">
                                            <select name="taille" required>
                                                <option value="">Taille conteneur</option>
                                                <option value="20">20 pieds</option>
                                                <option value="40">40 pieds</option>
                                                <option value="45">45 pieds</option>
                                            </select>
                                            <input type="text" name="plomb" placeholder="N¬∞ Plomb" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-add" onclick="ajouterConteneur(0)">‚ûï Ajouter
                                    Conteneur</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-add" onclick="ajouterArticle()">‚ûï Ajouter Article</button>
                    </div>

                    <button type="submit" class="btn btn-primary" id="btn-submit">
                        üöÄ Enregistrer le manifeste (√âtapes 1-5)
                    </button>
                </form>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-test" onclick="testerConnexionKit()">
                        üîß Tester Kit d'Interconnexion
                    </button>
                    <button class="btn btn-diagnostic" onclick="lancerDiagnostic()">
                        ü©∫ Diagnostic Complet
                    </button>
                </div>
            </section>

            <section class="card">
                <h2>üìÑ Manifestes R√©cents - Port de Dakar</h2>
                <div class="manifeste-list" id="manifestes-list">
                    <p>Chargement des manifestes...</p>
                </div>
                <button class="btn btn-test" onclick="chargerManifestes()" style="width: 100%; margin-top: 15px;">
                    üîÑ Actualiser
                </button>
            </section>

            <section class="card full-width" id="apurement-section" style="display: none;">
                <h2>üîì Apurement et Lev√©e des Marchandises (√âtapes 18-19)</h2>
                <div class="form-section">
                    <h3>üìã Confirmation Apurement - Port de Dakar</h3>
                    <div id="apurement-info" style="display: none;">
                        <div class="manifeste-item transmitted">
                            <div class="manifeste-header">
                                Manifeste: <span id="apu-numero-manifeste">--</span>
                            </div>
                            <div class="manifeste-details">
                                üö¢ Navire: <span id="apu-navire">--</span><br>
                                üè¢ Consignataire: <span id="apu-transporteur">--</span><br>
                                üí∞ Montant acquitt√©: <span id="apu-montant">--</span> FCFA<br>
                                üè≥Ô∏è Pays d√©clarant: <span id="apu-pays">--</span><br>
                                üìÖ Date r√©ception: <span id="apu-date-mainlevee">--</span>
                            </div>
                        </div>

                        <div class="form-row" style="margin-top: 20px;">
                            <div>
                                <label for="type-confirmation">Type de Confirmation:</label>
                                <select id="type-confirmation" class="form-control">
                                    <option value="DOUANE">Confirmation Douane</option>
                                    <option value="BCEAO">Confirmation BCEAO</option>
                                </select>
                            </div>
                            <div>
                                <label for="agent-confirmation">Agent de Confirmation:</label>
                                <input type="text" id="agent-confirmation" class="form-control"
                                    placeholder="Nom de l'agent" required>
                            </div>
                        </div>

                        <div class="form-row single" style="margin-top: 15px;">
                            <div>
                                <label for="observations">Observations:</label>
                                <textarea id="observations" class="form-control" rows="3"
                                    placeholder="Observations √©ventuelles..."></textarea>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="confirmerApurement()" id="btn-confirmer-apurement">
                                ‚úÖ Confirmer l'Apurement et la Lev√©e
                            </button>
                            <button class="btn btn-secondary" onclick="fermerApurement()" style="margin-left: 10px;">
                                ‚ùå Annuler
                            </button>
                        </div>
                    </div>

                    <div id="apurement-loading" style="display: none; text-align: center; padding: 40px;">
                        <div class="loading"></div>
                        <p style="margin-top: 20px;">Chargement des informations d'apurement...</p>
                    </div>

                    <div id="apurement-error" style="display: none; text-align: center; padding: 40px;">
                        <p style="color: #dc3545;">‚ùå <span id="apurement-error-message">Erreur de chargement</span></p>
                        <button class="btn btn-secondary" onclick="fermerApurement()" style="margin-top: 20px;">
                            Fermer
                        </button>
                    </div>

                    <div id="apurement-success" style="display: none; text-align: center; padding: 40px;">
                        <h3 style="color: #28a745;">‚úÖ Workflow S√©n√©gal Termin√©!</h3>
                        <p style="margin-top: 20px;">
                            Le manifeste <strong id="success-manifeste">--</strong> a √©t√© apur√© et les marchandises
                            peuvent √™tre lev√©es au Port de Dakar.
                        </p>
                        <div class="manifeste-item transmitted" style="margin: 20px auto; max-width: 600px;">
                            <div class="manifeste-details">
                                üìã Bon √† enlever: <span id="success-ref-apurement">--</span><br>
                                üîì Type confirmation: <span id="success-type-confirmation">--</span><br>
                                üë§ Agent: <span id="success-agent">--</span><br>
                                üìÖ Date apurement: <span id="success-date">--</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="fermerApurement()" style="margin-top: 20px;">
                            ‚úÖ Terminer
                        </button>
                    </div>
                </div>
            </section>

            <section class="card full-width">
                <h2>üîó Interactions Kit d'Interconnexion - Workflow Temps R√©el</h2>
                <div class="kit-interactions" id="kit-interactions">
                    <div class="interaction-item">
                        <div class="interaction-header">
                            <div class="interaction-title">üá∏üá≥ Syst√®me S√©n√©gal initialis√©</div>
                            <div class="interaction-time" id="init-time"></div>
                        </div>
                        <div>Port de Dakar - Monitoring des √©changes avec Kit d'Interconnexion activ√© - Format UEMOA</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ============================================================================
        // S√âN√âGAL - JavaScript adapt√© au Port de Dakar
        // ============================================================================

        const API_BASE = window.location.origin + '/api';
        let statusInterval;
        let refreshInterval;
        let kitConnected = false;
        let articleCount = 1;

        // ‚úÖ FONCTION HELPER pour valeurs de champs
        function getFieldValue(id, defaultValue = '') {
            try {
                const element = document.getElementById(id);
                if (element && element.value !== undefined) {
                    const value = element.value.toString().trim();
                    return value || defaultValue;
                }
                return defaultValue;
            } catch (error) {
                console.warn(`Erreur getFieldValue ${id}:`, error);
                return defaultValue;
            }
        }

        // ‚úÖ FONCTION HELPER pour acc√®s s√©curis√© aux propri√©t√©s
        function getValue(obj, path, fallback = null) {
            if (!obj || !path) return fallback;

            try {
                const keys = path.split('.');
                let current = obj;

                for (let i = 0; i < keys.length; i++) {
                    if (current && typeof current === 'object' && keys[i] in current) {
                        current = current[keys[i]];
                    } else {
                        return fallback;
                    }
                }

                return current !== null && current !== undefined ? current : fallback;
            } catch (error) {
                console.warn('Erreur getValue:', path, error);
                return fallback;
            }
        }

        // ‚úÖ FONCTION HELPER pour mettre √† jour des √©l√©ments DOM
        function setElementText(id, value, fallback = '--') {
            try {
                const element = document.getElementById(id);
                if (element) {
                    const displayValue = (value !== null && value !== undefined) ? value : fallback;
                    element.textContent = displayValue;
                    return true;
                }
                return false;
            } catch (error) {
                console.warn(`Erreur setElementText ${id}:`, error);
                return false;
            }
        }

        // ‚úÖ GESTION DYNAMIQUE DES ARTICLES
        function ajouterArticle() {
            articleCount++;
            const container = document.getElementById('articles-container');
            const articleDiv = document.createElement('div');
            articleDiv.className = 'article-section';
            articleDiv.setAttribute('data-article', articleCount - 1);

            articleDiv.innerHTML = `
        <h4>Article ${articleCount} <button type="button" onclick="supprimerArticle(${articleCount - 1})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; margin-left: 10px;">‚ùå</button></h4>
        <div class="form-row triple">
            <input type="number" name="art" placeholder="N¬∞ Article" value="${articleCount}" required>
            <input type="number" name="prec1" placeholder="Pr√©cision 1" value="0">
            <input type="number" name="prec2" placeholder="Pr√©cision 2" value="0">
        </div>
        <div class="form-row">
            <input type="date" name="date_emb" placeholder="Date embarquement" required>
            <input type="text" name="lieu_emb" placeholder="Lieu embarquement" required>
        </div>
        <div class="form-row">
            <select name="pays_dest" required>
                <option value="">Pays destination</option>
                <option value="MALI">üá≤üá± MALI</option>
                <option value="BURKINA FASO">üáßüá´ BURKINA FASO</option>
                <option value="NIGER">üá≥üá™ NIGER</option>
                <option value="C√îTE D'IVOIRE">üá®üáÆ C√îTE D'IVOIRE</option>
                <option value="GUINEA-BISSAU">üá¨üáº GUINEA-BISSAU</option>
                <option value="TOGO">üáπüá¨ TOGO</option>
                <option value="B√âNIN">üáßüáØ B√âNIN</option>
            </select>
            <input type="text" name="ville_dest" placeholder="Ville destination" required>
        </div>
        <div class="form-row">
            <input type="text" name="connaissement" placeholder="Connaissement" required>
            <input type="text" name="expediteur" placeholder="Exp√©diteur" required>
        </div>
        <div class="form-row">
            <input type="text" name="destinataire" placeholder="Destinataire" required>
            <input type="text" name="voie_dest" placeholder="Voie destination">
        </div>
        <div class="form-row">
            <input type="text" name="ordre" placeholder="√Ä l'ordre de">
            <input type="text" name="marchandise" placeholder="Description marchandise" required>
        </div>
        <div class="form-row triple">
            <input type="number" name="poids" placeholder="Poids (kg)" step="0.01" required>
            <input type="number" name="nbre_colis" placeholder="Nombre colis" required>
            <input type="text" name="marque" placeholder="Marque" value="NM">
        </div>
        <div class="form-row">
            <input type="text" name="mode_cond" placeholder="Mode conditionnement" value="COLIS (PACKAGE)">
            <input type="number" name="nbre_conteneur" placeholder="Nombre conteneurs" value="1" min="0">
        </div>
        <div class="conteneurs-container">
            <div class="conteneur-section" data-conteneur="0">
                <h5>Conteneur 1</h5>
                <div class="form-row">
                    <input type="text" name="conteneur" placeholder="N¬∞ Conteneur" required>
                    <select name="type" required>
                        <option value="">Type conteneur</option>
                        <option value="DRS">DRS - Dry Standard</option>
                        <option value="REF">REF - Refrigerated</option>
                        <option value="OPT">OPT - Open Top</option>
                        <option value="FLT">FLT - Flat Rack</option>
                    </select>
                </div>
                <div class="form-row">
                    <select name="taille" required>
                        <option value="">Taille conteneur</option>
                        <option value="20">20 pieds</option>
                        <option value="40">40 pieds</option>
                        <option value="45">45 pieds</option>
                    </select>
                    <input type="text" name="plomb" placeholder="N¬∞ Plomb" required>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-add" onclick="ajouterConteneur(${articleCount - 1})">‚ûï Ajouter Conteneur</button>
    `;

            container.appendChild(articleDiv);
        }

        function supprimerArticle(articleIndex) {
            const articleDiv = document.querySelector(`[data-article="${articleIndex}"]`);
            if (articleDiv && document.querySelectorAll('.article-section').length > 1) {
                articleDiv.remove();
            } else {
                afficherNotification('‚ö†Ô∏è Au moins un article est requis', 'warning');
            }
        }

        function ajouterConteneur(articleIndex) {
            const articleDiv = document.querySelector(`[data-article="${articleIndex}"]`);
            const conteneursContainer = articleDiv.querySelector('.conteneurs-container');
            const conteneurCount = conteneursContainer.children.length + 1;

            const conteneurDiv = document.createElement('div');
            conteneurDiv.className = 'conteneur-section';
            conteneurDiv.setAttribute('data-conteneur', conteneurCount - 1);

            conteneurDiv.innerHTML = `
        <h5>Conteneur ${conteneurCount} <button type="button" onclick="supprimerConteneur(${articleIndex}, ${conteneurCount - 1})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 2px 6px; margin-left: 10px; font-size: 10px;">‚ùå</button></h5>
        <div class="form-row">
            <input type="text" name="conteneur" placeholder="N¬∞ Conteneur" required>
            <select name="type" required>
                <option value="">Type conteneur</option>
                <option value="DRS">DRS - Dry Standard</option>
                <option value="REF">REF - Refrigerated</option>
                <option value="OPT">OPT - Open Top</option>
                <option value="FLT">FLT - Flat Rack</option>
            </select>
        </div>
        <div class="form-row">
            <select name="taille" required>
                <option value="">Taille conteneur</option>
                <option value="20">20 pieds</option>
                <option value="40">40 pieds</option>
                <option value="45">45 pieds</option>
            </select>
            <input type="text" name="plomb" placeholder="N¬∞ Plomb" required>
        </div>
    `;

            conteneursContainer.appendChild(conteneurDiv);
        }

        function supprimerConteneur(articleIndex, conteneurIndex) {
            const articleDiv = document.querySelector(`[data-article="${articleIndex}"]`);
            const conteneurDiv = articleDiv.querySelector(`[data-conteneur="${conteneurIndex}"]`);
            const conteneursContainer = articleDiv.querySelector('.conteneurs-container');

            if (conteneurDiv && conteneursContainer.children.length > 1) {
                conteneurDiv.remove();
            } else {
                afficherNotification('‚ö†Ô∏è Au moins un conteneur est requis par article', 'warning');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üá∏üá≥ Initialisation Syst√®me Douanier S√©n√©gal - Port de Dakar');

            try {
                const dateElement = document.getElementById('date_arrivee');
                if (dateElement) {
                    dateElement.value = new Date().toISOString().split('T')[0];
                }

                const dateEmbElement = document.querySelector('input[name="date_emb"]');
                if (dateEmbElement) {
                    dateEmbElement.value = new Date().toISOString().split('T')[0];
                }

                const initTimeElement = document.getElementById('init-time');
                if (initTimeElement) {
                    initTimeElement.textContent = new Date().toLocaleTimeString();
                }

                verifierStatutKit();
                statusInterval = setInterval(verifierStatutKit, 30000);

                chargerDonnees();
                refreshInterval = setInterval(chargerDonnees, 10000);

                const form = document.getElementById('manifeste-form');
                if (form) {
                    form.addEventListener('submit', creerManifeste);
                }

                ajouterInteraction('üá∏üá≥ Port de Dakar d√©marr√©', 'S√©n√©gal - Pays de prime abord - Format UEMOA activ√©');

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Erreur initialisation:', error);
                ajouterInteraction('‚ö†Ô∏è Initialisation', 'Erreur partielle: ' + (error.message || 'Erreur inconnue'));
            }
        });

        // ‚úÖ CR√âATION DE MANIFESTE - √âTAPES 1-5 du workflow S√©n√©gal
        async function creerManifeste(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('btn-submit');
            if (!submitBtn) {
                console.error('[S√âN√âGAL] Bouton submit introuvable');
                return;
            }

            const originalText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> √âtapes 1-5 en cours...';

            try {
                console.log('üá∏üá≥ [S√âN√âGAL] D√âBUT WORKFLOW - Cr√©ation manifeste Port de Dakar');

                const manifesteUEMOA = {
                    annee_manif: getFieldValue('annee_manif'),
                    bureau_manif: getFieldValue('bureau_manif'),
                    numero_manif: parseInt(getFieldValue('numero_manif')) || Date.now(),
                    code_cgt: getFieldValue('code_cgt'),
                    consignataire: getFieldValue('consignataire'),
                    repertoire: getFieldValue('repertoire'),
                    navire: getFieldValue('navire'),
                    provenance: getFieldValue('provenance'),
                    pavillon: getFieldValue('pavillon'),
                    date_arrivee: getFieldValue('date_arrivee'),
                    valapprox: parseFloat(getFieldValue('valapprox', '0')) || 0,
                    nbre_article: 0,
                    articles: []
                };

                const articleSections = document.querySelectorAll('.article-section');

                articleSections.forEach((section, index) => {
                    const article = {
                        art: parseInt(section.querySelector('input[name="art"]')?.value) || (index + 1),
                        prec1: parseInt(section.querySelector('input[name="prec1"]')?.value) || 0,
                        prec2: parseInt(section.querySelector('input[name="prec2"]')?.value) || 0,
                        date_emb: section.querySelector('input[name="date_emb"]')?.value || manifesteUEMOA.date_arrivee,
                        lieu_emb: section.querySelector('input[name="lieu_emb"]')?.value || manifesteUEMOA.provenance,
                        pays_dest: section.querySelector('select[name="pays_dest"]')?.value || '',
                        ville_dest: section.querySelector('input[name="ville_dest"]')?.value || '',
                        connaissement: section.querySelector('input[name="connaissement"]')?.value || '',
                        expediteur: section.querySelector('input[name="expediteur"]')?.value || '',
                        destinataire: section.querySelector('input[name="destinataire"]')?.value || '',
                        voie_dest: section.querySelector('input[name="voie_dest"]')?.value || '',
                        ordre: section.querySelector('input[name="ordre"]')?.value || '',
                        marchandise: section.querySelector('input[name="marchandise"]')?.value || '',
                        poids: parseFloat(section.querySelector('input[name="poids"]')?.value) || 0,
                        nbre_colis: parseInt(section.querySelector('input[name="nbre_colis"]')?.value) || 1,
                        marque: section.querySelector('input[name="marque"]')?.value || 'NM',
                        mode_cond: section.querySelector('input[name="mode_cond"]')?.value || 'COLIS (PACKAGE)',
                        nbre_conteneur: parseInt(section.querySelector('input[name="nbre_conteneur"]')?.value) || 1,
                        conteneurs: []
                    };

                    const conteneurSections = section.querySelectorAll('.conteneur-section');
                    conteneurSections.forEach(conteneurSection => {
                        const conteneur = {
                            conteneur: conteneurSection.querySelector('input[name="conteneur"]')?.value || '',
                            type: conteneurSection.querySelector('select[name="type"]')?.value || 'DRS',
                            taille: conteneurSection.querySelector('select[name="taille"]')?.value || '40',
                            plomb: conteneurSection.querySelector('input[name="plomb"]')?.value || ''
                        };
                        article.conteneurs.push(conteneur);
                    });

                    manifesteUEMOA.articles.push(article);
                });

                manifesteUEMOA.nbre_article = manifesteUEMOA.articles.length;

                console.log('üá∏üá≥ [S√âN√âGAL] Manifeste UEMOA pr√©par√©:', manifesteUEMOA);

                const erreurs = [];
                if (!manifesteUEMOA.numero_manif) erreurs.push('Num√©ro manifeste requis');
                if (!manifesteUEMOA.consignataire) erreurs.push('Consignataire requis');
                if (!manifesteUEMOA.date_arrivee) erreurs.push('Date arriv√©e requise');
                if (manifesteUEMOA.articles.length === 0) erreurs.push('Au moins un article requis');

                if (erreurs.length > 0) {
                    throw new Error('Validation √©chou√©e: ' + erreurs.join(', '));
                }

                ajouterInteraction('üá∏üá≥ √âTAPES 1-3: Cr√©ation manifeste',
                    `N¬∞${manifesteUEMOA.numero_manif} - ${manifesteUEMOA.consignataire} - ${manifesteUEMOA.articles.length} articles`);

                const response = await fetch(API_BASE + '/manifeste/creer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-Country': 'SEN',
                        'X-Source-System': 'SENEGAL_DOUANES_FRONTEND',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(manifesteUEMOA),
                    signal: AbortSignal.timeout(90000)
                });

                console.log(`üá∏üá≥ [S√âN√âGAL] R√©ponse HTTP: ${response.status}`);

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = getValue(errorData, 'message', errorMessage);
                    } catch (parseError) {
                        console.warn('[S√âN√âGAL] Impossible de parser erreur serveur');
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('üá∏üá≥ [S√âN√âGAL] R√©sultat:', getValue(result, 'status', 'UNKNOWN'));

                const resultStatus = getValue(result, 'status', 'UNKNOWN');

                if (resultStatus === 'SUCCESS') {
                    afficherNotification('üá∏üá≥ ‚úÖ Workflow S√©n√©gal r√©ussi - √âtapes 1-5 termin√©es!', 'success');

                    const manifesteId = getValue(result, 'manifeste.numero_manif', manifesteUEMOA.numero_manif);
                    const kitReussi = getValue(result, 'transmissionKit.reussie', false);

                    if (kitReussi) {
                        ajouterInteraction('üöÄ √âTAPES 4-5: Transmission Kit',
                            `‚úÖ Extraction transmise vers pays destination - Manifeste N¬∞${manifesteId}`);
                    } else {
                        ajouterInteraction('‚ö†Ô∏è √âTAPES 4-5: Kit d\'Interconnexion',
                            `Extraction non transmise - Mode local uniquement`);
                    }

                    resetForm();

                } else if (resultStatus === 'PARTIAL_SUCCESS') {
                    afficherNotification('üá∏üá≥ ‚ö†Ô∏è Manifeste cr√©√©, erreur transmission Kit d\'Interconnexion', 'warning');

                    const erreurKit = getValue(result, 'transmissionKit.echec.erreur', 'Erreur Kit inconnue');
                    ajouterInteraction('‚ö†Ô∏è √âTAPES 4-5: Transmission Kit', `√âchec - ${erreurKit}`);

                } else {
                    const errorMessage = getValue(result, 'message', 'Erreur serveur inconnue');
                    throw new Error(errorMessage);
                }

                await new Promise(resolve => setTimeout(resolve, 1000));
                await Promise.allSettled([
                    chargerStatistiques().catch(err => console.warn('Erreur stats:', err)),
                    chargerManifestes().catch(err => console.warn('Erreur manifestes:', err))
                ]);

            } catch (error) {
                console.error('üá∏üá≥ [S√âN√âGAL] Erreur workflow:', error);
                const errorMessage = error.message || 'Erreur inconnue';
                afficherNotification('üá∏üá≥ ‚ùå Erreur: ' + errorMessage, 'error');
                ajouterInteraction('‚ùå Workflow S√©n√©gal', `Erreur: ${errorMessage}`);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        }

        // ‚úÖ RESET FORM
        function resetForm() {
            try {
                const form = document.getElementById('manifeste-form');
                if (form) {
                    form.reset();

                    document.getElementById('date_arrivee').value = new Date().toISOString().split('T')[0];
                    document.querySelector('input[name="date_emb"]').value = new Date().toISOString().split('T')[0];

                    document.getElementById('annee_manif').value = '2025';
                    document.getElementById('bureau_manif').value = '18N';
                    document.getElementById('code_cgt').value = '014';
                    document.getElementById('repertoire').value = '02402';
                    document.getElementById('valapprox').value = '0';

                    console.log('üá∏üá≥ [S√âN√âGAL] Formulaire r√©initialis√©');
                }
            } catch (error) {
                console.warn('[S√âN√âGAL] Erreur reset form:', error);
            }
        }

        // ‚úÖ V√âRIFICATION STATUT KIT D'INTERCONNEXION
        async function verifierStatutKit() {
            try {
                console.log('üîç [S√âN√âGAL] Test statut Kit d\'Interconnexion...');

                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-Country': 'SEN',
                        'X-Source-System': 'SENEGAL_FRONTEND'
                    },
                    signal: AbortSignal.timeout(15000)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const kitInfo = getValue(data, 'kit', {});
                const accessible = getValue(kitInfo, 'accessible', false);
                const status = getValue(kitInfo, 'status', 'UNKNOWN');
                const latence = getValue(kitInfo, 'latence', null);

                const banner = document.getElementById('kit-banner');
                const indicator = document.getElementById('kit-indicator');
                const statusText = document.getElementById('kit-status-text');
                const details = document.getElementById('kit-details');

                if (accessible) {
                    if (banner) {
                        banner.className = 'kit-status-banner connected';
                        banner.innerHTML = `‚úÖ Kit d'Interconnexion op√©rationnel - ${status} ${latence ? `(${latence}ms)` : ''}`;
                    }

                    if (indicator) indicator.className = 'status-indicator connected';
                    if (statusText) statusText.textContent = 'Kit Op√©rationnel';
                    if (details) details.textContent = latence ? `Latence: ${latence}ms` : 'Connect√©';

                    kitConnected = true;
                } else {
                    if (banner) {
                        banner.className = 'kit-status-banner disconnected';
                        banner.innerHTML = `‚ö†Ô∏è Kit d'Interconnexion inaccessible - Service local S√©n√©gal op√©rationnel`;
                    }

                    if (indicator) indicator.className = 'status-indicator';
                    if (statusText) statusText.textContent = 'Kit Inaccessible';
                    if (details) details.textContent = 'Mode local uniquement';

                    kitConnected = false;
                }

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Erreur v√©rification Kit:', error);
                const banner = document.getElementById('kit-banner');
                if (banner) {
                    banner.className = 'kit-status-banner disconnected';
                    banner.innerHTML = `‚ö†Ô∏è Kit d'Interconnexion non v√©rifiable - Service S√©n√©gal actif`;
                }
                kitConnected = false;
            }
        }

        // ‚úÖ CHARGEMENT STATISTIQUES S√âN√âGAL
        async function chargerStatistiques() {
            try {
                console.log('üìä [S√âN√âGAL] Chargement statistiques Port de Dakar...');

                const response = await fetch(`${API_BASE}/statistiques`, {
                    signal: AbortSignal.timeout(15000)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìä [S√âN√âGAL] Statistiques re√ßues:', getValue(data, 'status', 'UNKNOWN'));

                const dataStatus = getValue(data, 'status', 'ERROR');
                const stats = getValue(data, 'statistiques', {});

                if (stats && ['SUCCESS', 'PARTIAL', 'DEGRADED'].includes(dataStatus)) {
                    setElementText('stat-manifestes', getValue(stats, 'manifestesCreees', 0));
                    setElementText('stat-transmissions', getValue(stats, 'transmissionsKit', 0));
                    setElementText('stat-succes', getValue(stats, 'transmissionsReussies', 0));

                    const tauxReussite = getValue(stats, 'performance.tauxReussiteGlobal', 100) || 100;
                    setElementText('taux-reussite', tauxReussite + '%');

                    const latenceMoyenne = getValue(stats, 'performance.latenceMoyenne', 0) || 0;
                    setElementText('latence-moyenne', latenceMoyenne > 0 ? latenceMoyenne + ' ms' : '-- ms');

                    console.log('‚úÖ [S√âN√âGAL] Statistiques mises √† jour');

                    const kitData = getValue(data, 'kit', {});
                    if (kitData) {
                        kitConnected = getValue(kitData, 'accessible', false);
                    }

                } else {
                    console.warn('‚ö†Ô∏è [S√âN√âGAL] Statistiques non disponibles, statut:', dataStatus);
                }

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Erreur chargement statistiques:', error);

                const elements = ['stat-manifestes', 'stat-transmissions', 'stat-succes'];
                elements.forEach(id => {
                    try {
                        const element = document.getElementById(id);
                        if (element && (element.textContent === '0' || element.textContent === '')) {
                            element.textContent = '--';
                            element.style.color = '#ffc107';
                        }
                    } catch (elemError) {
                        console.warn(`[S√âN√âGAL] Erreur mise √† jour ${id}:`, elemError);
                    }
                });
            }
        }

        // ‚úÖ CHARGEMENT MANIFESTES S√âN√âGAL
        async function chargerManifestes() {
            try {
                const response = await fetch(`${API_BASE}/manifeste/lister?limite=5`, {
                    signal: AbortSignal.timeout(10000)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const container = document.getElementById('manifestes-list');

                if (!container) return;

                const dataStatus = getValue(data, 'status', 'ERROR');
                const manifestes = getValue(data, 'manifestes', []);

                if (dataStatus === 'SUCCESS' && Array.isArray(manifestes) && manifestes.length > 0) {
                    container.innerHTML = manifestes.map(manifeste => {
                        const transmission = getValue(manifeste, 'transmission', {});
                        const reussie = getValue(transmission, 'reussie', false);
                        const statutTransmission = getValue(transmission, 'statut', 'UNKNOWN');

                        const transmissionClass = reussie ? 'transmitted' :
                            statutTransmission === 'ERREUR' ? 'error' : '';

                        const statusBadge = reussie ?
                            '<span class="transmission-status success">‚úÖ Transmis Kit</span>' :
                            statutTransmission === 'ERREUR' ?
                                '<span class="transmission-status error">‚ùå Erreur Kit</span>' :
                                '<span class="transmission-status pending">‚è≥ En attente</span>';

                        const numeroManifeste = getValue(manifeste, 'numero_manif', null) || getValue(manifeste, 'numeroManifeste', 'N/A');
                        const consignataire = getValue(manifeste, 'consignataire', null) || getValue(manifeste, 'transporteur', 'N/A');
                        const navire = getValue(manifeste, 'navire', 'N/A');
                        const nombreArticles = getValue(manifeste, 'nbre_article', 0) || getValue(manifeste, 'marchandises.nombre', 0);
                        const dateCreation = getValue(manifeste, 'dateCreation', null);

                        return `
                  <div class="manifeste-item ${transmissionClass}">
                    <div class="manifeste-header">N¬∞${numeroManifeste} - ${consignataire}</div>
                    <div class="manifeste-details">
                      üö¢ ${navire}<br>
                      üì¶ ${nombreArticles} article(s)<br>
                      üìÖ ${dateCreation ? new Date(dateCreation).toLocaleString('fr-FR') : 'N/A'}<br>
                      ${statusBadge}
                    </div>
                  </div>
                `;
                    }).join('');
                } else {
                    container.innerHTML = '<p>Aucun manifeste trouv√© au Port de Dakar</p>';
                }

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Erreur chargement manifestes:', error);
                const container = document.getElementById('manifestes-list');
                if (container) {
                    container.innerHTML = '<p style="color: #ffc107;">‚ö†Ô∏è Erreur de chargement des manifestes</p>';
                }
            }
        }

        // ‚úÖ TEST CONNEXION KIT D'INTERCONNEXION
        async function testerConnexionKit() {
            ajouterInteraction('üîß Test Kit d\'Interconnexion', 'Test de connectivit√©...');
            afficherNotification('üîß Test Kit en cours...', 'info');

            try {
                console.log('üîß [S√âN√âGAL] Test Kit d\'Interconnexion avec retry...');

                const tentatives = [
                    { timeout: 15000, nom: 'Standard' },
                    { timeout: 30000, nom: '√âtendu' },
                    { timeout: 60000, nom: 'Maximum' }
                ];

                let derni√®reErreur = null;

                for (let i = 0; i < tentatives.length; i++) {
                    const tentative = tentatives[i];
                    console.log(`üîß [S√âN√âGAL] Tentative ${i + 1}/${tentatives.length} (timeout: ${tentative.timeout}ms)...`);

                    try {
                        const startTime = Date.now();

                        const response = await fetch(`${API_BASE}/health`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Source-Country': 'SEN',
                                'X-Source-System': 'SENEGAL_TEST_KIT',
                                'X-Test-Type': 'CONNECTIVITY'
                            },
                            signal: AbortSignal.timeout(tentative.timeout)
                        });

                        const duration = Date.now() - startTime;
                        console.log(`üîß [S√âN√âGAL] R√©ponse re√ßue en ${duration}ms (tentative ${i + 1})`);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        const kitInfo = getValue(data, 'kit', {});
                        const accessible = getValue(kitInfo, 'accessible', false);
                        const latence = getValue(kitInfo, 'latence', duration);
                        const erreur = getValue(kitInfo, 'erreur', null);

                        if (accessible) {
                            console.log(`‚úÖ [S√âN√âGAL] Kit accessible (tentative ${i + 1}, latence: ${latence}ms)`);
                            afficherNotification(`‚úÖ Kit d'Interconnexion accessible (${latence}ms) - Tentative ${i + 1}`, 'success');
                            ajouterInteraction('üîß Test Kit', `‚úÖ Succ√®s tentative ${i + 1} - Latence: ${latence}ms`);
                            return true;
                        } else {
                            throw new Error(erreur || 'Kit inaccessible selon health check');
                        }

                    } catch (tentativeError) {
                        derni√®reErreur = tentativeError;
                        console.warn(`‚ö†Ô∏è [S√âN√âGAL] Tentative ${i + 1} √©chou√©e:`, tentativeError.message);

                        if (i < tentatives.length - 1) {
                            console.log(`‚è≥ [S√âN√âGAL] Attente 3s avant tentative ${i + 2}...`);
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        }
                    }
                }

                throw new Error(`Toutes les tentatives √©chou√©es. Derni√®re erreur: ${derni√®reErreur?.message || 'Erreur inconnue'}`);

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Test Kit √©chou√©:', error);

                let errorMessage = error.message || 'Erreur inconnue';

                if (errorMessage.includes('signal timed out')) {
                    errorMessage = 'Timeout - Kit d\'Interconnexion met trop de temps √† r√©pondre';
                } else if (errorMessage.includes('Failed to fetch')) {
                    errorMessage = 'Impossible de joindre le Kit d\'Interconnexion';
                } else if (errorMessage.includes('NetworkError')) {
                    errorMessage = 'Erreur r√©seau - Kit d\'Interconnexion indisponible';
                }

                afficherNotification(`‚ùå Kit inaccessible: ${errorMessage}`, 'error');
                ajouterInteraction('üîß Test Kit', `‚ùå √âchec: ${errorMessage}`);
                return false;
            }
        }

        // ‚úÖ DIAGNOSTIC COMPLET
        async function lancerDiagnostic() {
            ajouterInteraction('ü©∫ Diagnostic', 'Diagnostic Port de Dakar...');
            afficherNotification('ü©∫ Diagnostic en cours...', 'info');

            const resultats = {
                serviceSenegal: false,
                kitInterconnexion: false,
                baseDonnees: false
            };

            try {
                try {
                    console.log('ü©∫ [S√âN√âGAL] Test service local...');
                    const healthResponse = await fetch(`${API_BASE}/health`, {
                        signal: AbortSignal.timeout(10000)
                    });
                    resultats.serviceSenegal = healthResponse.ok;

                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();
                        const kitInfo = getValue(healthData, 'kit', {});
                        resultats.kitInterconnexion = getValue(kitInfo, 'accessible', false);
                    }
                } catch (healthError) {
                    console.warn('ü©∫ [S√âN√âGAL] Erreur test sant√©:', healthError);
                }

                try {
                    console.log('ü©∫ [S√âN√âGAL] Test base de donn√©es...');
                    const statsResponse = await fetch(`${API_BASE}/statistiques`, {
                        signal: AbortSignal.timeout(10000)
                    });
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        resultats.baseDonnees = !!getValue(statsData, 'statistiques', null);
                    }
                } catch (statsError) {
                    console.warn('ü©∫ [S√âN√âGAL] Erreur test BDD:', statsError);
                }

                const testsReussis = Object.values(resultats).filter(Boolean).length;
                const totalTests = Object.keys(resultats).length;

                const message = `Termin√© - ${testsReussis}/${totalTests} composants op√©rationnels`;
                ajouterInteraction('ü©∫ Diagnostic', message);

                if (testsReussis >= 2) {
                    afficherNotification(`‚úÖ Syst√®me S√©n√©gal fonctionnel - ${message}`, 'success');
                } else if (testsReussis >= 1) {
                    afficherNotification(`‚ö†Ô∏è Syst√®me S√©n√©gal d√©grad√© - ${message}`, 'warning');
                } else {
                    afficherNotification(`‚ùå Syst√®me S√©n√©gal en panne - ${message}`, 'error');
                }

            } catch (error) {
                const errorMessage = error.message || 'Erreur inconnue';
                ajouterInteraction('ü©∫ Diagnostic', `‚ùå Erreur - ${errorMessage}`);
                afficherNotification('‚ùå Diagnostic √©chou√©', 'error');
            }
        }

        // ‚úÖ FONCTIONS APUREMENT (√âTAPES 18-19)
        window.ouvrirApurement = async function (numeroManifeste, referencePaiement) {
            console.log('üîì [S√âN√âGAL] Ouverture interface apurement:', { numeroManifeste, referencePaiement });

            document.getElementById('apurement-section').style.display = 'block';
            document.getElementById('apurement-info').style.display = 'none';
            document.getElementById('apurement-loading').style.display = 'block';
            document.getElementById('apurement-error').style.display = 'none';
            document.getElementById('apurement-success').style.display = 'none';

            window.apurementData = { numeroManifeste, referencePaiement };
            document.getElementById('apurement-section').scrollIntoView({ behavior: 'smooth', block: 'start' });

            try {
                const response = await fetch(`${API_BASE}/apurement/traiter?numeroManifeste=${numeroManifeste}&referencePaiement=${referencePaiement}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'SENEGAL_FRONTEND',
                        'X-Source-Country': 'SEN'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('üìã [S√âN√âGAL] Donn√©es apurement re√ßues:', result);

                if (result.status === 'SUCCESS' && result.data) {
                    const data = result.data;

                    if (data.apurement) {
                        throw new Error('Ce manifeste a d√©j√† √©t√© apur√© le ' + new Date(data.apurement.dateApurement).toLocaleString('fr-FR'));
                    }

                    if (!data.peutEtreApure) {
                        throw new Error('Ce manifeste ne peut pas √™tre apur√©. Statut: ' + data.manifeste.statut);
                    }

                    document.getElementById('apu-numero-manifeste').textContent = data.manifeste.numero;
                    document.getElementById('apu-navire').textContent = data.manifeste.navire;
                    document.getElementById('apu-transporteur').textContent = data.manifeste.consignataire;
                    document.getElementById('apu-montant').textContent = data.autorisation.montant.toLocaleString();
                    document.getElementById('apu-pays').textContent = data.autorisation.paysDeclarant;
                    document.getElementById('apu-date-mainlevee').textContent = new Date(data.autorisation.dateReception).toLocaleString('fr-FR');

                    document.getElementById('type-confirmation').value = 'DOUANE';
                    document.getElementById('agent-confirmation').value = '';
                    document.getElementById('observations').value = '';

                    document.getElementById('apurement-loading').style.display = 'none';
                    document.getElementById('apurement-info').style.display = 'block';

                    ajouterInteraction('üîì Apurement', `Interface ouverte pour manifeste ${numeroManifeste}`);

                } else {
                    throw new Error('Donn√©es apurement invalides');
                }

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Erreur chargement apurement:', error);
                document.getElementById('apurement-loading').style.display = 'none';
                document.getElementById('apurement-error').style.display = 'block';
                document.getElementById('apurement-error-message').textContent = error.message;
                ajouterInteraction('‚ùå Apurement', `Erreur: ${error.message}`);
            }
        };

        async function confirmerApurement() {
            const btnConfirmer = document.getElementById('btn-confirmer-apurement');
            const originalText = btnConfirmer.innerHTML;

            try {
                const agentConfirmation = document.getElementById('agent-confirmation').value.trim();
                if (!agentConfirmation) {
                    throw new Error('Veuillez saisir le nom de l\'agent de confirmation');
                }

                btnConfirmer.disabled = true;
                btnConfirmer.innerHTML = '<div class="loading"></div> √âtapes 18-19 en cours...';

                const apurementPayload = {
                    numeroManifeste: window.apurementData.numeroManifeste,
                    referencePaiement: window.apurementData.referencePaiement,
                    typeConfirmation: document.getElementById('type-confirmation').value,
                    agentConfirmation: agentConfirmation,
                    observations: document.getElementById('observations').value.trim()
                };

                console.log('üì§ [S√âN√âGAL] Envoi apurement:', apurementPayload);

                const response = await fetch(`${API_BASE}/apurement/traiter`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-System': 'SENEGAL_FRONTEND',
                        'X-Source-Country': 'SEN',
                        'X-Payment-Reference': window.apurementData.referencePaiement
                    },
                    body: JSON.stringify(apurementPayload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ [S√âN√âGAL] Apurement confirm√©:', result);

                if (result.status === 'SUCCESS') {
                    document.getElementById('apurement-info').style.display = 'none';
                    document.getElementById('apurement-success').style.display = 'block';

                    document.getElementById('success-manifeste').textContent = result.apurement.numeroManifeste;
                    document.getElementById('success-ref-apurement').textContent = result.bonEnlever.id;
                    document.getElementById('success-type-confirmation').textContent = result.apurement.typeConfirmation;
                    document.getElementById('success-agent').textContent = apurementPayload.agentConfirmation;
                    document.getElementById('success-date').textContent = new Date(result.apurement.dateApurement).toLocaleString('fr-FR');

                    afficherNotification('‚úÖ Workflow S√©n√©gal termin√© - √âtapes 18-19 compl√©t√©es!', 'success');
                    ajouterInteraction('‚úÖ √âTAPES 18-19', `Apurement et lev√©e confirm√©s - Manifeste ${result.apurement.numeroManifeste}`);

                    setTimeout(() => {
                        chargerManifestes();
                        chargerStatistiques();
                    }, 2000);

                } else {
                    throw new Error(result.message || 'Erreur lors de l\'apurement');
                }

            } catch (error) {
                console.error('‚ùå [S√âN√âGAL] Erreur confirmation apurement:', error);
                afficherNotification('‚ùå Erreur: ' + error.message, 'error');
                ajouterInteraction('‚ùå Apurement', `Erreur: ${error.message}`);
            } finally {
                btnConfirmer.disabled = false;
                btnConfirmer.innerHTML = originalText;
            }
        }

        function fermerApurement() {
            document.getElementById('apurement-section').style.display = 'none';
            window.apurementData = null;

            if (window.opener) {
                window.close();
            }
        }

        // ‚úÖ FONCTIONS UTILITAIRES
        async function chargerDonnees() {
            try {
                await Promise.allSettled([
                    chargerStatistiques().catch(err => console.warn('[S√âN√âGAL] Erreur stats:', err)),
                    chargerManifestes().catch(err => console.warn('[S√âN√âGAL] Erreur manifestes:', err))
                ]);
            } catch (error) {
                console.error('[S√âN√âGAL] Erreur chargement donn√©es:', error);
            }
        }

        function ajouterInteraction(title, details) {
            try {
                const container = document.getElementById('kit-interactions');
                if (!container) return;

                const timestamp = new Date().toLocaleTimeString();
                const safeTitle = (title || 'Action').toString().substring(0, 100);
                const safeDetails = (details || 'D√©tails non disponibles').toString().substring(0, 200);

                const item = document.createElement('div');
                item.className = 'interaction-item';

                if (safeDetails.includes('‚ùå') || safeDetails.includes('Erreur') || safeDetails.includes('√âchec')) {
                    item.classList.add('error');
                } else if (safeDetails.includes('‚ö†Ô∏è') || safeDetails.includes('Partiel')) {
                    item.classList.add('warning');
                }

                item.innerHTML = `
          <div class="interaction-header">
            <div class="interaction-title">${safeTitle}</div>
            <div class="interaction-time">${timestamp}</div>
          </div>
          <div>${safeDetails}</div>
        `;

                container.prepend(item);

                const items = container.querySelectorAll('.interaction-item');
                if (items.length > 15) {
                    for (let i = 15; i < items.length; i++) {
                        try {
                            items[i].remove();
                        } catch (removeError) {
                            console.warn('[S√âN√âGAL] Erreur suppression interaction:', removeError);
                        }
                    }
                }
            } catch (error) {
                console.warn('[S√âN√âGAL] Erreur ajout interaction:', error);
            }
        }

        function afficherNotification(message, type) {
            try {
                const notification = document.getElementById('notification');
                if (!notification) return;

                const safeMessage = (message || 'Notification').toString().substring(0, 150);
                const safeType = ['success', 'error', 'warning', 'info'].includes(type) ? type : 'info';

                notification.textContent = safeMessage;
                notification.className = `notification ${safeType}`;
                notification.classList.add('show');

                const duration = safeType === 'error' ? 7000 : safeType === 'warning' ? 5000 : 3000;

                setTimeout(() => {
                    try {
                        notification.classList.remove('show');
                    } catch (hideError) {
                        console.warn('[S√âN√âGAL] Erreur masquage notification:', hideError);
                    }
                }, duration);
            } catch (error) {
                console.warn('[S√âN√âGAL] Erreur affichage notification:', error);
            }
        }

        // ‚úÖ V√âRIFICATION URL APUREMENT
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const numeroManifeste = urlParams.get('apurement_manifeste');
            const referencePaiement = urlParams.get('apurement_paiement');

            if (numeroManifeste && referencePaiement) {
                console.log('üîì [S√âN√âGAL] Ouverture apurement depuis URL');
                setTimeout(() => {
                    window.ouvrirApurement(numeroManifeste, referencePaiement);
                }, 1000);
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            try {
                if (statusInterval) clearInterval(statusInterval);
                if (refreshInterval) clearInterval(refreshInterval);
            } catch (error) {
                console.warn('[S√âN√âGAL] Erreur cleanup:', error);
            }
        });

        console.log('üá∏üá≥ ‚úÖ Script Syst√®me Douanier S√©n√©gal - Port de Dakar initialis√©');
    </script>
</body>

</html>