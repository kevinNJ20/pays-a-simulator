# üá∏üá≥ Simulateur Syst√®me Douanier S√©n√©gal - Port de Dakar

**Version 1.0.0** | Pays de Prime Abord | Node.js 22.x | Format UEMOA 2025.1

---

## üéØ R√¥le dans l'Interconnexion UEMOA

Le S√©n√©gal est le **Pays de Prime Abord** (Pays A) - point d'entr√©e des marchandises dans l'espace UEMOA via le Port de Dakar.

| Propri√©t√© | Valeur |
|-----------|--------|
| **Code Pays** | SEN |
| **Type** | Pays C√¥tier |
| **R√¥le** | PAYS_PRIME_ABORD |
| **Port Principal** | Port de Dakar (Bureau 18N) |
| **Format** | UEMOA 2025.1 |

---

## üìã Workflows G√©r√©s par le S√©n√©gal

### 1Ô∏è‚É£ Workflow Libre Pratique (21 √©tapes au total)

Le S√©n√©gal g√®re **6 √©tapes sur 21** :

#### **√âtapes 1-5 : Entr√©e et Transmission (AUTOMATIQUE)**
```
Port de Dakar ‚Üí Kit MuleSoft ‚Üí Pays de Destination
```

**D√©tail des √©tapes :**
- **√âtape 1-2** : T√©l√©chargement et r√©ception manifeste par consignataire
- **√âtape 3** : Renseignement informations marchandise (articles, conteneurs)
- **√âtape 4** : Extraction marchandises pour pays destination
- **√âtape 5** : Transmission extraction via Kit MuleSoft

**API correspondante :** `POST /api/manifeste/creer`

#### **√âtapes 17-19 : Retour et Apurement (MANUEL)**
```
Mali (Pays B) ‚Üí Kit MuleSoft ‚Üí Port de Dakar
```

**D√©tail des √©tapes :**
- **√âtape 17** : R√©ception automatique informations d√©claration/recouvrement depuis Mali
- **√âtape 18** : **üë§ MANUEL** - Apurement du manifeste par agent douanier
- **√âtape 19** : **üë§ MANUEL** - Attribution main lev√©e (Bon √† Enlever - BAE)

**APIs correspondantes :**
- `POST /api/mainlevee/autorisation` (√âtape 17 - Automatique)
- `GET /api/apurement/traiter` (Consultation avant apurement)
- `POST /api/apurement/traiter` (√âtapes 18-19 - Action manuelle agent)

#### **√âtapes 6-16 : Traitement au Mali** 
*(Non g√©r√©es par le S√©n√©gal - Pays de destination)*

---

### 2Ô∏è‚É£ Workflow Transit (16 √©tapes au total)

Le S√©n√©gal g√®re **9 √©tapes sur 16** :

#### **√âtapes 1-9 : Cr√©ation Transit au D√©part (AUTOMATIQUE)**
```
Port de Dakar (Cr√©ation) ‚Üí Transit commence
```

**D√©tail des √©tapes :**
- **√âtapes 1-6** : Cr√©ation d√©claration transit au d√©part
  - D√©p√¥t et enregistrement d√©claration
  - V√©rification conformit√© et recevabilit√©
  - Enregistrement d√©taill√©
- **√âtapes 7-9** : Garanties et autorisation d√©part (automatique lors cr√©ation)
  - Prise de garanties (cautions, itin√©raire, d√©lais)
  - Paiement redevances transit
  - D√©livrance bon √† enlever / Autorisation d√©part

**API :** `POST /api/transit/creer`

#### **√âtapes 10-11 : Transmission Copie Transit (AUTOMATIQUE)**
```
Port de Dakar ‚Üí Kit MuleSoft ‚Üí Mali (Destination)
```

**D√©tail :**
- Transmission automatique copie d√©claration vers pays destination
- Le Kit MuleSoft route vers le bureau destination

**API :** `POST /api/transit/creer` (inclus dans la cr√©ation)

#### **√âtape 14 : Message Arriv√©e (AUTOMATIQUE)**
```
Mali ‚Üí Kit MuleSoft ‚Üí Port de Dakar
```

**D√©tail :**
- R√©ception automatique confirmation arriv√©e depuis Mali
- Enregistrement contr√¥les effectu√©s au bureau destination

**API :** `POST /api/transit/arrivee`

#### **√âtapes 15-16 : Apurement Transit (MANUEL)**
```
Port de Dakar ‚Üí Apurement manuel par agent
```

**D√©tail des √©tapes :**
- **√âtape 15** : **üë§ MANUEL** - Apurement du transit par agent douanier
  - V√©rification conformit√© (itin√©raire, d√©lais respect√©s)
  - Confirmation arriv√©e marchandises
  - Validation contr√¥les destination
- **√âtape 16** : **üë§ MANUEL** - Lib√©ration des garanties
  - Lib√©ration cautions
  - Cl√¥ture du transit
  - Archivage dossier

**API :** `POST /api/transit/apurer` (Action manuelle agent)

#### **√âtapes 11-13 : Traitement au Mali**
*(Non g√©r√©es par le S√©n√©gal - Pays de destination)*

---

## üöÄ D√©marrage Rapide

### Installation
```bash
git clone <repository-url>
cd simulateur-senegal
npm install
npm start
```

### Acc√®s
- **Dashboard Libre Pratique** : http://64.225.5.75:3001/libre-pratique.html
- **Dashboard Transit** : http://64.225.5.75:3001/transit.html
- **Health Check** : http://64.225.5.75:3001/api/health
- **Statistiques** : http://64.225.5.75:3001/api/statistiques

---

## üîå APIs Principales

### Workflow Libre Pratique

| √âtape | Endpoint | M√©thode | Type | Description |
|-------|----------|---------|------|-------------|
| 1-5 | `/api/manifeste/creer` | POST | ‚úÖ Auto | Cr√©ation manifeste + transmission Kit |
| 17 | `/api/mainlevee/autorisation` | POST | ‚úÖ Auto | R√©ception info paiement Mali |
| 18-19 | `/api/apurement/traiter` | GET | üìã Info | Consultation avant apurement |
| 18-19 | `/api/apurement/traiter` | POST | üë§ Manuel | Apurement + main lev√©e par agent |
| - | `/api/manifeste/lister` | GET | üìã Info | Liste manifestes |

### Workflow Transit

| √âtape | Endpoint | M√©thode | Type | Description |
|-------|----------|---------|------|-------------|
| 1-9 | `/api/transit/creer` | POST | ‚úÖ Auto | Cr√©ation transit + garanties + autorisation |
| 10-11 | `/api/transit/creer` | POST | ‚úÖ Auto | Transmission copie (inclus) |
| 14 | `/api/transit/arrivee` | POST | ‚úÖ Auto | Message arriv√©e Mali |
| 15-16 | `/api/transit/apurer` | POST | üë§ Manuel | Apurement + lib√©ration garanties par agent |
| - | `/api/transit/lister` | GET | üìã Info | Liste transits |

### Syst√®me

| Endpoint | Description |
|----------|-------------|
| `/api/health` | √âtat syst√®me + Kit MuleSoft |
| `/api/statistiques` | M√©triques temps r√©el |
| `/api/auth/login` | Authentification utilisateur |
| `/api/auth/verify` | V√©rification session |
| `/api/auth/logout` | D√©connexion |

---

## üìä Exemple Complet : Workflow Libre Pratique

### 1. Cr√©ation Manifeste (√âtapes 1-5) - AUTOMATIQUE

```bash
curl -X POST http://64.225.5.75:3001/api/manifeste/creer \
  -H "Content-Type: application/json" \
  -d '{
    "annee_manif": "2025",
    "bureau_manif": "18N",
    "numero_manif": 5016,
    "consignataire": "MAERSK LINE SENEGAL",
    "navire": "MARCO POLO",
    "date_arrivee": "2025-01-15",
    "articles": [{
      "art": 1,
      "pays_dest": "MALI",
      "ville_dest": "BAMAKO",
      "marchandise": "V√©hicule Toyota",
      "poids": 1500,
      "destinataire": "IMPORT SARL BAMAKO"
    }]
  }'
```

**R√©sultat :**
```json
{
  "status": "SUCCESS",
  "message": "Manifeste cr√©√© et transmis vers Mali",
  "workflow": {
    "etapesCompletes": "1-5",
    "prochaine_etape": "Attente traitement Mali (√©tapes 6-16)"
  }
}
```

---

### 2. R√©ception Autorisation Mali (√âtape 17) - AUTOMATIQUE

```bash
curl -X POST http://64.225.5.75:3001/api/mainlevee/autorisation \
  -H "Content-Type: application/json" \
  -d '{
    "autorisationMainlevee": {
      "numeroManifeste": "5016",
      "montantAcquitte": 250000,
      "paysDeclarant": "MLI",
      "referencePaiement": "PAY-MLI-2025-001"
    }
  }'
```

---

### 3. Apurement et Lev√©e (√âtapes 18-19) - MANUEL PAR AGENT

#### 3.1 Consultation avant apurement
```bash
curl -X GET "http://64.225.5.75:3001/api/apurement/traiter?numeroManifeste=5016&referencePaiement=PAY-MLI-2025-001"
```

#### 3.2 Action manuelle d'apurement par agent
```bash
curl -X POST http://64.225.5.75:3001/api/apurement/traiter \
  -H "Content-Type: application/json" \
  -d '{
    "numeroManifeste": "5016",
    "referencePaiement": "PAY-MLI-2025-001",
    "typeConfirmation": "DOUANE",
    "agentConfirmation": "AGENT_DOUANES_DAKAR",
    "observations": "RAS - Paiement v√©rifi√©"
  }'
```

**R√©sultat :**
```json
{
  "status": "SUCCESS",
  "message": "üéâ Workflow S√©n√©gal termin√© - Apurement et lev√©e confirm√©s",
  "apurement": {
    "id": "APU_SEN_...",
    "statutApurement": "CONFIRME"
  },
  "bonEnlever": {
    "id": "BAE_SEN_...",
    "portEnlevement": "Port de Dakar"
  }
}
```

---

## üìä Exemple Complet : Workflow Transit

### 1. Cr√©ation Transit (√âtapes 1-9) - AUTOMATIQUE

```bash
curl -X POST http://64.225.5.75:3001/api/transit/creer \
  -H "Content-Type: application/json" \
  -d '{
    "numeroDeclaration": "TRA-SEN-2025-001",
    "transporteur": "TRANSPORT SAHEL",
    "modeTransport": "ROUTIER",
    "paysDestination": "MALI",
    "itineraire": "Dakar-Bamako via Kayes",
    "delaiRoute": "72 heures",
    "cautionRequise": 500000,
    "referenceCaution": "CAUTION-2025-001",
    "marchandises": [{
      "designation": "Mat√©riel informatique",
      "poids": 2500,
      "nombreColis": 50,
      "marques": "HP-DELL"
    }]
  }'
```

**R√©sultat :**
```json
{
  "status": "SUCCESS",
  "message": "D√©claration transit cr√©√©e et copie transmise",
  "workflow": {
    "etapesCompletes": "1-11",
    "prochaine_etape": "Attente arriv√©e Mali (√©tapes 13-14)"
  },
  "transit": {
    "id": "TRA_SEN_...",
    "numeroDeclaration": "TRA-SEN-2025-001",
    "statut": "TRANSIT_CREE"
  }
}
```

**Notes importantes :**
- ‚úÖ √âtapes 1-6 : Cr√©ation et enregistrement
- ‚úÖ √âtapes 7-9 : Garanties/paiement/autorisation d√©part (automatique)
- ‚úÖ √âtapes 10-11 : Transmission copie vers Mali (automatique)

---

### 2. R√©ception Message Arriv√©e (√âtape 14) - AUTOMATIQUE

```bash
# Cet appel est fait automatiquement par le Mali via le Kit MuleSoft
curl -X POST http://64.225.5.75:3001/api/transit/arrivee \
  -H "Content-Type: application/json" \
  -d '{
    "messageArrivee": {
      "numeroDeclaration": "TRA-SEN-2025-001",
      "bureauArrivee": "BAMAKO_PRINCIPAL",
      "dateArrivee": "2025-01-23T10:00:00Z",
      "controleEffectue": true,
      "visaAppose": true,
      "conformiteItineraire": true,
      "delaiRespecte": true
    }
  }'
```

---

### 3. Apurement Transit (√âtapes 15-16) - MANUEL PAR AGENT

#### 3.1 L'agent visualise le transit pr√™t pour apurement
L'interface web `/transit.html` affiche automatiquement les transits ayant re√ßu le message d'arriv√©e (√©tape 14).

#### 3.2 Action manuelle d'apurement par agent
```bash
curl -X POST http://64.225.5.75:3001/api/transit/apurer \
  -H "Content-Type: application/json" \
  -d '{
    "numeroDeclaration": "TRA-SEN-2025-001",
    "agentApurement": "AGENT_TRANSIT_DAKAR",
    "observations": "Conformit√© v√©rifi√©e - D√©lai respect√©"
  }'
```

**R√©sultat :**
```json
{
  "status": "SUCCESS",
  "message": "üéâ Workflow Transit termin√© - Apurement et lib√©ration garanties confirm√©s",
  "workflow": {
    "status": "TERMINE",
    "etapesCompletes": "1-16 (complet)"
  },
  "apurement": {
    "id": "APU_TRA_SEN_...",
    "numeroDeclaration": "TRA-SEN-2025-001",
    "statutApurement": "CONFIRME",
    "etapeTransit": 15
  },
  "liberationGaranties": {
    "id": "LIB_GAR_SEN_...",
    "cautionLiberee": 500000,
    "etapeTransit": 16
  }
}
```

---

## üé® Interface Web

### Pages disponibles
1. **Connexion** : `/login.html`
2. **Libre Pratique** : `/libre-pratique.html`
3. **Transit** : `/transit.html`

### Comptes de d√©monstration
```
admin / admin123 (Tous workflows)
douane / douane2025 (Tous workflows)
lp_user / lp123 (Libre pratique)
transit_user / transit123 (Transit)
```

### Fonctionnalit√©s Interface Libre Pratique
- ‚úÖ Cr√©ation manifestes format UEMOA avec formulaire interactif
- ‚úÖ Gestion multi-articles et conteneurs
- ‚úÖ **Section d√©di√©e manifestes √† apurer** (√âtape 17 re√ßue)
- ‚úÖ **Interface apurement manuelle** (√âtapes 18-19) avec :
  - Consultation informations d√©claration/paiement
  - Saisie agent confirmant l'apurement
  - Observations facultatives
  - Validation et g√©n√©ration Bon √† Enlever
- ‚úÖ Suivi workflow temps r√©el
- ‚úÖ Monitoring Kit MuleSoft

### Fonctionnalit√©s Interface Transit
- ‚úÖ Cr√©ation d√©clarations transit avec formulaire
- ‚úÖ Gestion marchandises et garanties
- ‚úÖ **Section d√©di√©e transits √† apurer** (√âtape 14 re√ßue)
- ‚úÖ **Interface apurement manuelle** (√âtapes 15-16) avec :
  - Consultation message arriv√©e
  - V√©rification conformit√© itin√©raire/d√©lais
  - Saisie agent confirmant l'apurement
  - Observations facultatives
  - Lib√©ration automatique garanties
- ‚úÖ Suivi workflow temps r√©el
- ‚úÖ Monitoring Kit MuleSoft

---

## üìà Statuts du Workflow

### Libre Pratique

| Statut | √âtapes | Description |
|--------|--------|-------------|
| `MANIFESTE_CREE` | 1-3 | Cr√©√© au Port de Dakar |
| `TRANSMIS_VERS_DESTINATION` | 1-5 | Envoy√© au Mali via Kit |
| `DECLARATION_RECUE` | 1-5, 17 | Info paiement re√ßue - **Pr√™t apurement** |
| `APURE` | 1-5, 17-18 | Apurement confirm√© manuellement |
| `MAINLEVEE_ATTRIBUEE` | 1-5, 17-19 | Bon √† enlever √©mis ‚úÖ |

### Transit

| Statut | √âtapes | Description |
|--------|--------|-------------|
| `TRANSIT_CREE` | 1-9 | Cr√©√© au Port de Dakar avec garanties |
| `COPIE_TRANSMISE` | 1-11 | Copie envoy√©e au Mali via Kit |
| `ARRIVEE_CONFIRMEE` | 1-11, 14 | Message arriv√©e re√ßu - **Pr√™t apurement** |
| `TRANSIT_APURE` | 1-16 | Apurement confirm√© + garanties lib√©r√©es ‚úÖ |

---

## üîó Architecture d'Interconnexion

```
Port de Dakar (S√©n√©gal)
    ‚Üì √âTAPES 1-5 (Libre Pratique) ou 1-11 (Transit)
Kit MuleSoft (http://64.225.5.75:8086)
    ‚Üì Routage
Mali/Burkina/Niger (Destination)
    ‚Üì √âTAPES 6-16 (Libre Pratique) ou 13-14 (Transit)
Kit MuleSoft
    ‚Üì √âTAPE 17 (Libre Pratique) ou 14 (Transit)
Port de Dakar
    ‚Üì √âTAPES 18-19 (Libre Pratique) ou 15-16 (Transit)
    üë§ ACTION MANUELLE AGENT DOUANIER
‚úÖ Workflow Termin√©
```

---

## üîß Configuration

### Variables d'environnement
```env
PORT=3001
KIT_MULESOFT_URL=http://64.225.5.75:8086/api/v1
PAYS_CODE=SEN
PORT_NAME=Port de Dakar
PAYS_ROLE=PAYS_PRIME_ABORD
```

### Structure du Projet
```
simulateur-senegal/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ auth/                          # Authentification
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logout.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ verify.js
‚îÇ   ‚îú‚îÄ‚îÄ health.js                      # Health check
‚îÇ   ‚îú‚îÄ‚îÄ statistiques.js                # Stats supervision
‚îÇ   ‚îú‚îÄ‚îÄ manifeste/                     # Workflow Libre Pratique
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ creer.js                   # √âTAPES 1-5
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lister.js
‚îÇ   ‚îú‚îÄ‚îÄ mainlevee/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ autorisation.js            # √âTAPE 17 (auto)
‚îÇ   ‚îú‚îÄ‚îÄ apurement/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ traiter.js                 # √âTAPES 18-19 (manuel)
‚îÇ   ‚îú‚îÄ‚îÄ transit/                       # Workflow Transit
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ creer.js                   # √âTAPES 1-11
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ arrivee.js                 # √âTAPE 14 (auto)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apurer.js                  # √âTAPES 15-16 (manuel)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lister.js
‚îÇ   ‚îî‚îÄ‚îÄ kit/
‚îÇ       ‚îî‚îÄ‚îÄ test.js                    # Tests Kit MuleSoft
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ database.js                    # Base donn√©es S√©n√©gal
‚îÇ   ‚îî‚îÄ‚îÄ kit-client.js                  # Client Kit MuleSoft
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ index.html                     # Page d'accueil
‚îÇ   ‚îú‚îÄ‚îÄ login.html                     # Authentification
‚îÇ   ‚îú‚îÄ‚îÄ libre-pratique.html            # Dashboard Libre Pratique
‚îÇ   ‚îú‚îÄ‚îÄ transit.html                   # Dashboard Transit
‚îÇ   ‚îú‚îÄ‚îÄ auth.js                        # Script auth client
‚îÇ   ‚îú‚îÄ‚îÄ script.js                      # Logique frontend
‚îÇ   ‚îî‚îÄ‚îÄ style.css
‚îú‚îÄ‚îÄ server.js                          # Serveur HTTP
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

---

## üÜò Support

**D√©velopp√© par** : Cabinet Jasmine Conseil  
**Conformit√©** : Rapport PDF UEMOA - Interconnexion SI Douaniers  
**Version** : 1.0.0-UEMOA  
**Runtime** : Node.js 22.x

**Contact** : douanes.dakar@gouv.sn

---

## üîë Points Cl√©s - Actions Manuelles

### Workflow Libre Pratique
- ‚úÖ **√âtapes 1-5** : Automatiques via formulaire web
- ‚úÖ **√âtape 17** : Automatique depuis Kit MuleSoft
- üë§ **√âtapes 18-19** : **MANUELLES** - Agent douanier confirme apurement et d√©livre BAE

### Workflow Transit
- ‚úÖ **√âtapes 1-11** : Automatiques via formulaire web
- ‚úÖ **√âtape 14** : Automatique depuis Kit MuleSoft
- üë§ **√âtapes 15-16** : **MANUELLES** - Agent douanier apure transit et lib√®re garanties

**Justification des actions manuelles :**
- V√©rification humaine des documents et paiements
- Validation conformit√© r√©glementaire
- D√©cision finale sur lib√©ration marchandises/garanties
- Tra√ßabilit√© et responsabilit√© administrative

---

## üìÑ Licence

¬© 2025 Cabinet Jasmine Conseil - Tous droits r√©serv√©s

*Simulateur S√©n√©gal - Port de Dakar - Pays de Prime Abord UEMOA*
